# -*- coding: utf-8 -*-
"""Prosodic_Deepfake_Detection.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1dH3dSLccJq_5KW9NbHk2V1drAFq8NzQW

# –ß–∞—Å—Ç—å 1: –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–Ω—Ç–∞–Ω–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∏ —Ä–∏—Ç–º–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –∏–∑ OpenSmile

## –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
"""

from google.colab import files
import zipfile
import os
import glob
import pandas as pd
import shutil

def upload_and_extract_audio():
    """
    –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–æ–≤ —Å –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞–º–∏
    """
    uploaded = files.upload()

    # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
    natural_dir = '/content/natural_audio'
    synthetic_dir = '/content/synthetic_audio'

    if os.path.exists(natural_dir):
        shutil.rmtree(natural_dir)
    if os.path.exists(synthetic_dir):
        shutil.rmtree(synthetic_dir)

    os.makedirs(natural_dir, exist_ok=True)
    os.makedirs(synthetic_dir, exist_ok=True)

    # –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–æ–≤
    natural_found = False
    synthetic_found = False

    for filename in uploaded.keys():
        print(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞: {filename}")
        filepath = os.path.join('/content', filename)

        # –£–±–∏—Ä–∞–µ–º "(1)", "(2)" –∏ —Ç.–¥. –∏–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
        filename_clean = filename.replace(' (1)', '').replace(' (2)', '').replace(' (3)', '').replace(' (4)', '')
        filename_lower = filename_clean.lower()

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—É—é —Ä–µ—á—å
        if '–Ω–∞—Ç—É—Ä' in filename_lower or 'natural' in filename_lower or 'real' in filename_lower or 'bona' in filename_lower:
            new_filepath = '/content/natural.zip'
            if filepath != new_filepath:
                os.rename(filepath, new_filepath)
            with zipfile.ZipFile(new_filepath, 'r') as zip_ref:
                zip_ref.extractall(natural_dir)
            print(f"  –¢–∏–ø: –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è —Ä–µ—á—å")
            print(f"  –†–∞—Å–ø–∞–∫–æ–≤–∞–Ω–æ –≤: {natural_dir}")
            natural_found = True

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫—É—é —Ä–µ—á—å (–¥–æ–±–∞–≤–ª–µ–Ω–∞ —è–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã)
        elif '—Ñ–µ–π–∫' in filename_lower or 'fake' in filename_lower or 'synthetic' in filename_lower or 'spoof' in filename_lower:
            new_filepath = '/content/synthetic.zip'
            if filepath != new_filepath:
                os.rename(filepath, new_filepath)
            with zipfile.ZipFile(new_filepath, 'r') as zip_ref:
                zip_ref.extractall(synthetic_dir)

            synthetic_found = True
        else:
            # –ï—Å–ª–∏ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª–∏ –ø–æ –∏–º–µ–Ω–∏, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—è–¥–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
            # –ü–µ—Ä–≤—ã–π —Ñ–∞–π–ª - –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è, –≤—Ç–æ—Ä–æ–π - —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∞—è
            files_list = list(uploaded.keys())
            if filename == files_list[0] and not natural_found:
                new_filepath = '/content/natural.zip'
                if filepath != new_filepath:
                    os.rename(filepath, new_filepath)
                with zipfile.ZipFile(new_filepath, 'r') as zip_ref:
                    zip_ref.extractall(natural_dir)

                natural_found = True
            elif filename == files_list[1] and not synthetic_found:
                new_filepath = '/content/synthetic.zip'
                if filepath != new_filepath:
                    os.rename(filepath, new_filepath)
                with zipfile.ZipFile(new_filepath, 'r') as zip_ref:
                    zip_ref.extractall(synthetic_dir)

                synthetic_found = True
            else:
                print(f"  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø —Ñ–∞–π–ª–∞")

    # –ü–æ–¥—Å—á–µ—Ç —Ñ–∞–π–ª–æ–≤
    natural_files = glob.glob(f"{natural_dir}/**/*.wav", recursive=True)
    synthetic_files = glob.glob(f"{synthetic_dir}/**/*.wav", recursive=True)

    print(f"  –ù–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è —Ä–µ—á—å: {len(natural_files)} —Ñ–∞–π–ª–æ–≤")
    print(f"  –°–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ—á—å: {len(synthetic_files)} —Ñ–∞–π–ª–æ–≤")

    if not natural_found or not synthetic_found:
        print("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ –≤—Å–µ –∞—Ä—Ö–∏–≤—ã –±—ã–ª–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω—ã")

    return natural_dir, synthetic_dir

# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
natural_path, synthetic_path = upload_and_extract_audio()

"""## –°–æ–∑–¥–∞–Ω–∏–µ DataFrame —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏"""

import pandas as pd
import glob
import os

def create_dataframe(natural_dir, synthetic_dir):
    """
    –°–æ–∑–¥–∞–Ω–∏–µ DataFrame —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞—Ö
    """

    # –ü–æ–∏—Å–∫ –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤
    natural_files = glob.glob(f"{natural_dir}/**/*.wav", recursive=True)
    synthetic_files = glob.glob(f"{synthetic_dir}/**/*.wav", recursive=True)

    # –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–ø–∏—Å–µ–π
    data_records = []

    for file_path in natural_files:
        data_records.append({
            'file_path': file_path,
            'type': 'bona_fide',
            'filename': os.path.basename(file_path)
        })

    for file_path in synthetic_files:
        data_records.append({
            'file_path': file_path,
            'type': 'spoof',
            'filename': os.path.basename(file_path)
        })

    df = pd.DataFrame(data_records)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
    natural_names = set(df[df['type'] == 'bona_fide']['filename'])
    synthetic_names = set(df[df['type'] == 'spoof']['filename'])
    paired_files = natural_names.intersection(synthetic_names)


    return df

audio_df = create_dataframe(natural_path, synthetic_path)

import pandas as pd
import glob
import os
import shutil

def reorganize_and_create_dataframe(natural_dir, synthetic_dir):
    """
    –†–µ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ DataFrame
    """

    # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –±–µ–∑ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
    natural_clean = '/content/audio_real'
    synthetic_clean = '/content/audio_fake'

    if os.path.exists(natural_clean):
        shutil.rmtree(natural_clean)
    if os.path.exists(synthetic_clean):
        shutil.rmtree(synthetic_clean)

    os.makedirs(natural_clean, exist_ok=True)
    os.makedirs(synthetic_clean, exist_ok=True)

    # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ –Ω–æ–≤—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    natural_files = glob.glob(f"{natural_dir}/**/*.wav", recursive=True)
    synthetic_files = glob.glob(f"{synthetic_dir}/**/*.wav", recursive=True)

    for src_path in natural_files:
        filename = os.path.basename(src_path)
        dst_path = os.path.join(natural_clean, filename)
        shutil.copy2(src_path, dst_path)

    for src_path in synthetic_files:
        filename = os.path.basename(src_path)
        dst_path = os.path.join(synthetic_clean, filename)
        shutil.copy2(src_path, dst_path)

    # –°–æ–∑–¥–∞–Ω–∏–µ DataFrame
    data_records = []

    for filename in os.listdir(natural_clean):
        if filename.endswith('.wav'):
            data_records.append({
                'file_path': os.path.join(natural_clean, filename),
                'label': 'real',
                'filename': filename
            })

    for filename in os.listdir(synthetic_clean):
        if filename.endswith('.wav'):
            data_records.append({
                'file_path': os.path.join(synthetic_clean, filename),
                'label': 'fake',
                'filename': filename
            })

    df = pd.DataFrame(data_records)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–Ω–æ—Å—Ç–∏
    real_files = set(df[df['label'] == 'real']['filename'])
    fake_files = set(df[df['label'] == 'fake']['filename'])
    paired = real_files.intersection(fake_files)

    return df

# –°–æ–∑–¥–∞–Ω–∏–µ —á–∏—Å—Ç–æ–≥–æ DataFrame
audio_df = reorganize_and_create_dataframe(natural_path, synthetic_path)

audio_df

"""## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —Å–±–æ—Ä–∫–∞ openSMILE"""

import subprocess
import os

def setup_opensmile():
    """
    –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–±–æ—Ä–∫–∞ openSMILE
    """

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è openSMILE
    if os.path.exists('/content/opensmile/build/progsrc/smilextract/SMILExtract'):
        print("openSMILE —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        return True

    # –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    if not os.path.exists('/content/opensmile'):
        result = subprocess.run(
            ['git', 'clone', 'https://github.com/audeering/opensmile.git'],
            cwd='/content',
            capture_output=True,
            text=True
        )
        if result.returncode != 0:
            print("–û—à–∏–±–∫–∞ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è")
            return False

    # –°–±–æ—Ä–∫–∞
    result = subprocess.run(
        ['bash', 'build.sh'],
        cwd='/content/opensmile',
        capture_output=True,
        text=True
    )

    if result.returncode == 0:
        return True
    else:
        print("–û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏")
        return False

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ openSMILE
setup_opensmile()

"""## –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∞–∫—É—Å—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤"""

import subprocess
from tqdm import tqdm

def extract_features(audio_df):
    """
    –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ eGeMAPSv02 –∏–∑ –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤
    """

    smile_path = "/content/opensmile/build/progsrc/smilextract/SMILExtract"
    config_path = "/content/opensmile/config/egemaps/v02/eGeMAPSv02.conf"

    features_list = []

    for idx, row in tqdm(audio_df.iterrows(), total=len(audio_df), desc="–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤"):
        audio_file = row['file_path']
        temp_csv = f"/content/temp_features_{idx}.csv"

        # –ö–æ–º–∞–Ω–¥–∞ openSMILE
        cmd = [
            smile_path,
            '-C', config_path,
            '-I', audio_file,
            '-O', temp_csv,
            '-l', '0'
        ]

        result = subprocess.run(cmd, capture_output=True, text=True, timeout=120)

        if result.returncode == 0 and os.path.exists(temp_csv):
            # –ß—Ç–µ–Ω–∏–µ CSV
            with open(temp_csv, 'r') as f:
                content = f.read()

            # –ü–∞—Ä—Å–∏–Ω–≥ ARFF —Ñ–æ—Ä–º–∞—Ç–∞
            if '@data' in content:
                data_line = content.split('@data')[-1].strip().split('\n')[0]
                values = data_line.split(',')

                if len(values) > 50:
                    features = {}
                    for i, val in enumerate(values[1:], 1):
                        try:
                            features[f'feature_{i}'] = float(val)
                        except:
                            features[f'feature_{i}'] = val

                    features['label'] = row['label']
                    features['filename'] = row['filename']
                    features_list.append(features)

            os.remove(temp_csv)

    features_df = pd.DataFrame(features_list)
    print(f"–ò–∑–≤–ª–µ—á–µ–Ω–æ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤: {len(features_df)} –∑–∞–ø–∏—Å–µ–π")

    return features_df

# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
features_df = extract_features(audio_df)

"""OpenSMILE –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –∫–∞–∂–¥—ã–π –∞—É–¥–∏–æ—Ñ–∞–π–ª:

- –†–∞–∑–±–∏–≤–∞–ª –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–µ–π–º—ã (~25–º—Å)
- –í—ã—á–∏—Å–ª—è–ª –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã (pitch, energy, —Å–ø–µ–∫—Ç—Ä)
- –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–ª —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (mean, std, min, max, percentiles)
- –í—ã–¥–∞–≤–∞–ª 88 –∏—Ç–æ–≥–æ–≤—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –Ω–∞ —Ñ–∞–π–ª

## –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
"""

def get_feature_names():
    """
    –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –∏–∑ ARFF —Ñ–∞–π–ª–∞
    """
    smile_path = "/content/opensmile/build/progsrc/smilextract/SMILExtract"
    config_path = "/content/opensmile/config/egemaps/v02/eGeMAPSv02.conf"
    test_audio = audio_df.iloc[0]['file_path']
    test_arff = "/content/feature_names.arff"

    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –∏–∑ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    cmd = [smile_path, '-C', config_path, '-I', test_audio, '-O', test_arff]
    subprocess.run(cmd, capture_output=True, text=True)

    # –ü–∞—Ä—Å–∏–Ω–≥ –Ω–∞–∑–≤–∞–Ω–∏–π –∏–∑ ARFF
    feature_names = []
    if os.path.exists(test_arff):
        with open(test_arff, 'r') as f:
            for line in f:
                if line.startswith('@attribute') and 'numeric' in line:
                    name = line.split()[1]
                    feature_names.append(name)

    print(f"–ù–∞–π–¥–µ–Ω–æ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤: {len(feature_names)}")
    print("\n–ü–µ—Ä–≤—ã–µ 10 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤:")
    for i, name in enumerate(feature_names[:10], 1):
        print(f"  {i:2d}. {name}")

    return feature_names

# –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π
feature_names = get_feature_names()

# –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫ –≤ DataFrame
rename_dict = {f'feature_{i}': feature_names[i-1]
               for i in range(1, len(feature_names) + 1)
               if i <= len(feature_names)}

features_df = features_df.rename(columns=rename_dict)

features_df

"""## –í—ã–¥–µ–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —Ä–∏—Ç–º–∏–∫–∏ –∏ –∏–Ω—Ç–æ–Ω–∞—Ü–∏–∏"""

def select_rhythm_intonation_features(features_df, readable_names):
    """
    –í—ã–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å —Ä–∏—Ç–º–∏–∫–æ–π –∏ –∏–Ω—Ç–æ–Ω–∞—Ü–∏–µ–π
    """

    # –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∏–ø—Ñ–µ–π–∫–æ–≤
    key_features = [
        'F0semitoneFrom27.5Hz_sma3nz_amean',
        'F0semitoneFrom27.5Hz_sma3nz_stddevNorm',
        'F0semitoneFrom27.5Hz_sma3nz_meanRisingSlope',
        'F0semitoneFrom27.5Hz_sma3nz_meanFallingSlope',
        'loudness_sma3_amean',
        'loudness_sma3_stddevNorm',
        'loudness_sma3_stddevFallingSlope',
        'MeanUnvoicedSegmentLength',
        'StddevUnvoicedSegmentLength',
        'MeanVoicedSegmentLengthSec',
        'VoicedSegmentsPerSec',
        'loudnessPeaksPerSec',
        'spectralFlux_sma3_amean'
    ]

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
    available_features = {}
    for feature in key_features:
        if feature in features_df.columns:
            available_features[feature] = readable_names.get(feature, feature)

    print(f"–í—ã–±—Ä–∞–Ω–æ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤: {len(available_features)}")
    print("\n–°–ø–∏—Å–æ–∫ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤:")
    for i, (feature, description) in enumerate(available_features.items(), 1):
        print(f"{i:2d}. {description}")

    return available_features

# –í—ã–¥–µ–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
key_features = select_rhythm_intonation_features(features_df, readable_feature_names)

"""## –†–∞—Å—á–µ—Ç EER –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–∑–Ω–∞–∫–∞"""

import numpy as np
from sklearn.metrics import roc_curve
from tqdm import tqdm

def compute_eer(scores, labels):
    """
    –í—ã—á–∏—Å–ª–µ–Ω–∏–µ Equal Error Rate
    """
    fpr, tpr, thresholds = roc_curve(labels, scores, pos_label=1)
    fnr = 1 - tpr
    eer_index = np.nanargmin(np.absolute(fnr - fpr))
    eer = fpr[eer_index]
    threshold = thresholds[eer_index]
    return eer, threshold

def analyze_features(features_df, key_features):
    """
    –ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–∑–Ω–∞–∫–∞
    """

    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –º–µ—Ç–æ–∫ (0 = real, 1 = fake)
    labels = (features_df['label'] == 'fake').astype(int)

    results = {}

    for feature in tqdm(key_features.keys(), desc="–†–∞—Å—á–µ—Ç EER"):
        scores = features_df[feature].values

        # –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–ª–∞—Å—Å–∞–º
        real_values = features_df[features_df['label'] == 'real'][feature]
        fake_values = features_df[features_df['label'] == 'fake'][feature]

        # –í—ã—á–∏—Å–ª–µ–Ω–∏–µ EER
        eer, threshold = compute_eer(scores, labels)

        results[feature] = {
            'eer': eer,
            'threshold': threshold,
            'mean_real': real_values.mean(),
            'mean_fake': fake_values.mean(),
            'std_real': real_values.std(),
            'std_fake': fake_values.std()
        }

    # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ EER (–ª—É—á—à–∏–µ –ø–µ—Ä–≤—ã–µ)
    results = dict(sorted(results.items(), key=lambda x: x[1]['eer']))

    return results

# –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
feature_results = analyze_features(features_df, key_features)

# –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
print("\n–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞:")

for i, (feature, stats) in enumerate(feature_results.items(), 1):
    readable_name = readable_feature_names.get(feature, feature)
    diff = stats['mean_fake'] - stats['mean_real']
    diff_pct = (abs(diff) / stats['mean_real'] * 100) if stats['mean_real'] != 0 else 0

    print(f"{i:2d}. {readable_name}")
    print(f"    EER: {stats['eer']:.3f} ({stats['eer']*100:.1f}% –æ—à–∏–±–æ–∫)")
    print(f"    Real: {stats['mean_real']:.4f} ¬± {stats['std_real']:.4f}")
    print(f"    Fake: {stats['mean_fake']:.4f} ¬± {stats['std_fake']:.4f}")
    print(f"    –†–∞–∑–Ω–∏—Ü–∞: {diff:+.4f} ({diff_pct:.1f}%)")

"""## –ê–Ω–∞–ª–∏–∑

Equal Error Rate (EER) - —ç—Ç–æ –ø—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞, –∫–æ–≥–¥–∞ –æ–Ω –æ–¥–∏–Ω–∞–∫–æ–≤–æ —á–∞—Å—Ç–æ:

- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç fake –∑–∞ real (–ª–æ–∂–Ω–æ–µ –ø—Ä–∏–Ω—è—Ç–∏–µ)
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç real –∑–∞ fake (–ª–æ–∂–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ)
- –ß–µ–º –º–µ–Ω—å—à–µ EER, —Ç–µ–º –ª—É—á—à–µ –ø—Ä–∏–∑–Ω–∞–∫ —Ä–∞–∑–ª–∏—á–∞–µ—Ç –∫–ª–∞—Å—Å—ã.

–†–ï–ó–£–õ–¨–¢–ê–¢–´

- –õ—É—á—à–∏–π –ø—Ä–∏–∑–Ω–∞–∫:

–í–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–∞—É–∑ - EER 38.3%

–£ fake –ø–∞—É–∑ –±–æ–ª–µ–µ –æ–¥–Ω–æ—Ä–æ–¥–Ω—ã–µ (+14%)

- –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ (EER 43-49%):

–ò–∑–º–µ–Ω—á–∏–≤–æ—Å—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç–∏, —Å–∫–æ—Ä–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–ø–µ–∫—Ç—Ä–∞, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–∞—É–∑
- –ü–ª–æ—Ö–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ (EER > 50%):
–í—Å–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –≤—ã—Å–æ—Ç—ã –≥–æ–ª–æ—Å–∞ (F0), —Ä–∏—Ç–º–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –¥–∏–ø—Ñ–µ–π–∫–∏ –æ—á–µ–Ω—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏ –æ–¥–∏–Ω–æ—á–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã

- –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –Ω–∞—Ö–æ–¥–∫–∏:

–£ fake –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –ø–∞—É–∑—ã (+14%) - —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä –¥–µ–ª–∞–µ—Ç –ø–∞—É–∑—ã –æ–¥–Ω–æ–æ–±—Ä–∞–∑–Ω–µ–µ;

–£ fake —á—É—Ç—å –≤—ã—à–µ –≥—Ä–æ–º–∫–æ—Å—Ç—å (+3.6%);

–£ real –±–æ–ª–µ–µ –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ–µ –ø–æ–Ω–∏–∂–µ–Ω–∏–µ –∏–Ω—Ç–æ–Ω–∞—Ü–∏–∏ (+17.8%).

## –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
"""

import matplotlib.pyplot as plt
import seaborn as sns

sns.set_style("whitegrid")

def plot_eer_comparison(feature_results, readable_names):
    """
    –ì—Ä–∞—Ñ–∏–∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è EER –≤—Å–µ—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
    """
    features_list = list(feature_results.keys())
    eer_values = [feature_results[f]['eer'] for f in features_list]
    readable_list = [readable_names.get(f, f)[:40] for f in features_list]

    colors = ['green' if eer < 0.4 else 'orange' if eer < 0.5 else 'red' for eer in eer_values]

    plt.figure(figsize=(12, 8))
    y_pos = range(len(readable_list))
    plt.barh(y_pos, eer_values, color=colors, alpha=0.7)
    plt.yticks(y_pos, readable_list, fontsize=9)
    plt.xlabel('Equal Error Rate (EER)')
    plt.title('–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –¥–∏–ø—Ñ–µ–π–∫–æ–≤', fontweight='bold', fontsize=12)
    plt.axvline(x=0.5, color='red', linestyle='--', alpha=0.5, label='–°–ª—É—á–∞–π–Ω–æ–µ —É–≥–∞–¥—ã–≤–∞–Ω–∏–µ')
    plt.axvline(x=0.4, color='green', linestyle='--', alpha=0.5, label='–•–æ—Ä–æ—à–∏–π –ø–æ—Ä–æ–≥')
    plt.legend(loc='lower right')
    plt.gca().invert_yaxis()
    plt.tight_layout()
    plt.savefig('/content/eer_comparison.png', dpi=300, bbox_inches='tight')
    plt.show()

plot_eer_comparison(feature_results, readable_feature_names)

"""–ì—Ä–∞—Ñ–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –¥–∏–ø—Ñ–µ–π–∫–∏ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –æ—Ç –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–æ–π —Ä–µ—á–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏–∑–±—ã—Ç–æ—á–Ω–æ–π –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å—é –ø–∞—É–∑ (+14%) –∏ —Å–≥–ª–∞–∂–µ–Ω–Ω—ã–º–∏ –Ω–∏—Å—Ö–æ–¥—è—â–∏–º–∏ –∏–Ω—Ç–æ–Ω–∞—Ü–∏—è–º–∏ (-17.8%), –≤ —Ç–æ –≤—Ä–µ–º—è –∫–∞–∫ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –¥—Ä—É–≥–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–≤—ã—Å–æ—Ç–∞ –≥–æ–ª–æ—Å–∞, –≥—Ä–æ–º–∫–æ—Å—Ç—å, —Ä–∏—Ç–º) –∏–º–∏—Ç–∏—Ä—É—é—Ç—Å—è —Å —Ä–∞–∑–ª–∏—á–∏–µ–º –º–µ–Ω–µ–µ 5%. –ü–∞—Ä–∞–¥–æ–∫—Å–∞–ª—å–Ω–æ, –Ω–æ –Ω–∞–∏–±–æ–ª—å—à–∏–µ —Ä–∞–∑–ª–∏—á–∏—è —Å—Ä–µ–¥–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏–∑-–∑–∞ –≤—ã—Å–æ–∫–æ–π –≤–Ω—É—Ç—Ä–∏–∫–ª–∞—Å—Å–æ–≤–æ–π –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏, —á—Ç–æ –æ–±—ä—è—Å–Ω—è–µ—Ç —Å–ª–∞–±—É—é —Ä–∞–±–æ—Ç—É –æ–¥–∏–Ω–æ—á–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤."""

def plot_feature_differences(feature_results, readable_names):
    """
    –ì—Ä–∞—Ñ–∏–∫ —Ä–∞–∑–Ω–∏—Ü—ã –º–µ–∂–¥—É Real –∏ Fake
    """
    features_list = list(feature_results.keys())
    readable_list = [readable_names.get(f, f)[:40] for f in features_list]

    differences = []
    for feature in features_list:
        diff_pct = ((feature_results[feature]['mean_fake'] - feature_results[feature]['mean_real']) /
                    feature_results[feature]['mean_real'] * 100) if feature_results[feature]['mean_real'] != 0 else 0
        differences.append(diff_pct)

    colors_diff = ['red' if d > 0 else 'blue' for d in differences]

    plt.figure(figsize=(12, 8))
    y_pos = range(len(readable_list))
    plt.barh(y_pos, differences, color=colors_diff, alpha=0.7)
    plt.yticks(y_pos, readable_list, fontsize=9)
    plt.xlabel('–†–∞–∑–Ω–∏—Ü–∞ (Fake - Real), %')
    plt.title('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–ª–∏—á–∏–π –ø—Ä–∏–∑–Ω–∞–∫–æ–≤', fontweight='bold', fontsize=12)
    plt.axvline(x=0, color='black', linestyle='-', linewidth=0.8)
    plt.gca().invert_yaxis()
    plt.grid(True, alpha=0.3, axis='x')
    plt.tight_layout()
    plt.savefig('/content/feature_differences.png', dpi=300, bbox_inches='tight')
    plt.show()

plot_feature_differences(feature_results, readable_feature_names)

"""–ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç —Ç–æ–Ω–∫—É—é –≥—Ä–∞–Ω—å –º–µ–∂–¥—É –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–æ–π –∏ —Å–∏–Ω—Ç–µ–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–µ—á—å—é. –î–∏–ø—Ñ–µ–π–∫–∏ –Ω–µ —Ä–∞–¥–∏–∫–∞–ª—å–Ω–æ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ (–±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Ä–∞–∑–ª–∏—á–∏–π <5%), –Ω–æ –∏–º–µ—é—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫—É—é —Å–∏–≥–Ω–∞—Ç—É—Ä—É –≤ –≤–∏–¥–µ:

–ò–∑–±—ã—Ç–æ—á–Ω–æ–π –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–∞—É–∑ (+14%)

–°–≥–ª–∞–∂–µ–Ω–Ω—ã—Ö –∏–Ω—Ç–æ–Ω–∞—Ü–∏–æ–Ω–Ω—ã—Ö –ø–∞–¥–µ–Ω–∏–π (-17.8%)

–§—Ä–∞–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (-4.9%)

# –ß–∞—Å—Ç—å 2: –ò–Ω–≤–µ—Ä—Å–∏—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π
"""

def inversion_experiment(features_df, feature_results, readable_names):
    """
    –ò–Ω–≤–µ—Ä—Å–∏—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π –¥–ª—è –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —Å EER > 0.5
    """

    # –ù–∞—Ö–æ–¥–∏–º –ø—Ä–∏–∑–Ω–∞–∫–∏ —Å EER > 0.5
    weak_features = {k: v for k, v in feature_results.items() if v['eer'] > 0.5}

    print(f"–ü—Ä–∏–∑–Ω–∞–∫–æ–≤ —Å EER > 0.5: {len(weak_features)}")

    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –º–µ—Ç–æ–∫
    labels = (features_df['label'] == 'fake').astype(int)

    inversion_results = []

    for feature, stats in weak_features.items():
        # –ò—Å—Ö–æ–¥–Ω—ã–µ scores
        scores = features_df[feature].values

        # –ò–Ω–≤–µ—Ä—Å–∏—è
        inverted_scores = -scores

        # –ü–µ—Ä–µ—Å—á–µ—Ç EER
        eer_original = stats['eer']
        eer_inverted, _ = compute_eer(inverted_scores, labels)

        improvement = eer_original - eer_inverted

        inversion_results.append({
            'feature': feature,
            'readable_name': readable_names.get(feature, feature),
            'eer_original': eer_original,
            'eer_inverted': eer_inverted,
            'improvement': improvement,
            'is_better': eer_inverted < eer_original
        })

    # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é
    inversion_results = sorted(inversion_results, key=lambda x: x['improvement'], reverse=True)

    # –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    print("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω–≤–µ—Ä—Å–∏–∏:")

    for i, result in enumerate(inversion_results, 1):
        status = "–£–ª—É—á—à–µ–Ω–∏–µ" if result['is_better'] else "–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
        print(f"{i}. {result['readable_name']}")
        print(f"   –î–æ –∏–Ω–≤–µ—Ä—Å–∏–∏:  EER = {result['eer_original']:.3f}")
        print(f"   –ü–æ—Å–ª–µ:        EER = {result['eer_inverted']:.3f}")
        print(f"   –ò–∑–º–µ–Ω–µ–Ω–∏–µ:    {result['improvement']:+.3f} ({status})")
        print()

    return inversion_results

# –ó–∞–ø—É—Å–∫ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞
inversion_results = inversion_experiment(features_df, feature_results, readable_feature_names)

"""–í—Å–µ 7 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —Å EER > 0.5 (—Ö—É–∂–µ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–≥–∞–¥—ã–≤–∞–Ω–∏—è) —É–ª—É—á—à–∏–ª–∏—Å—å –ø–æ—Å–ª–µ –∏–Ω–≤–µ—Ä—Å–∏–∏, —Å–æ —Å—Ä–µ–¥–Ω–∏–º —Å–Ω–∏–∂–µ–Ω–∏–µ–º –æ—à–∏–±–∫–∏ –Ω–∞ 0.055. –≠—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ä–∞–∑–ª–∏—á–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏, –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–º –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–º –æ–∂–∏–¥–∞–Ω–∏—è–º - –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –Ω–µ–≤–µ—Ä–Ω–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞–ª –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–ª–∏—á–∏–π –º–µ–∂–¥—É real –∏ fake.

## –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
"""

def create_final_results_table(feature_results, inversion_results, readable_names):
    """
    –°–æ–∑–¥–∞–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã –≤—Å–µ—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —Å —É—á–µ—Ç–æ–º –∏–Ω–≤–µ—Ä—Å–∏–∏
    """

    final_results = []

    # –°–ª–æ–≤–∞—Ä—å –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    inverted_dict = {r['feature']: r for r in inversion_results}

    for feature, stats in feature_results.items():
        readable_name = readable_names.get(feature, feature)
        eer_original = stats['eer']

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –ø—Ä–∏–∑–Ω–∞–∫ –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω
        if feature in inverted_dict:
            inv = inverted_dict[feature]
            best_eer = inv['eer_inverted']
            method = '–ò–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π'
            improved = inv['is_better']
        else:
            best_eer = eer_original
            method = '–ò—Å—Ö–æ–¥–Ω—ã–π'
            improved = False

        final_results.append({
            '–ü—Ä–∏–∑–Ω–∞–∫': readable_name,
            '–ò—Å—Ö–æ–¥–Ω—ã–π EER': eer_original,
            '–õ—É—á—à–∏–π EER': best_eer,
            '–ú–µ—Ç–æ–¥': method,
            '–£–ª—É—á—à–µ–Ω': '–î–∞' if improved else '–ù–µ—Ç'
        })

    # –°–æ–∑–¥–∞–Ω–∏–µ DataFrame
    final_df = pd.DataFrame(final_results)
    final_df = final_df.sort_values('–õ—É—á—à–∏–π EER')

    # –í—ã–≤–æ–¥ —Ç–∞–±–ª–∏—Ü—ã
    print(final_df.to_string(index=False))

    print(f"  –í—Å–µ–≥–æ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤: {len(final_df)}")
    print(f"  –£–ª—É—á—à–µ–Ω–æ –∏–Ω–≤–µ—Ä—Å–∏–µ–π: {final_df['–£–ª—É—á—à–µ–Ω'].value_counts().get('–î–∞', 0)}")
    print(f"  –õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {final_df.iloc[0]['–ü—Ä–∏–∑–Ω–∞–∫']} (EER = {final_df.iloc[0]['–õ—É—á—à–∏–π EER']:.3f})")
    print(f"  –°—Ä–µ–¥–Ω–∏–π EER (–∏—Å—Ö–æ–¥–Ω—ã–π): {final_df['–ò—Å—Ö–æ–¥–Ω—ã–π EER'].mean():.3f}")
    print(f"  –°—Ä–µ–¥–Ω–∏–π EER (–ª—É—á—à–∏–π): {final_df['–õ—É—á—à–∏–π EER'].mean():.3f}")

    return final_df

# –°–æ–∑–¥–∞–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã
final_results_df = create_final_results_table(feature_results, inversion_results, readable_feature_names)

"""–ò–∑ 13 –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ 7 (54%) —É–ª—É—á—à–∏–ª–∏—Å—å –ø–æ—Å–ª–µ –∏–Ω–≤–µ—Ä—Å–∏–∏, —á—Ç–æ —Å–Ω–∏–∑–∏–ª–æ —Å—Ä–µ–¥–Ω–∏–π EER —Å 0.492 –¥–æ 0.463 (—É–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ 6%). –õ—É—á—à–∏–º –ø—Ä–∏–∑–Ω–∞–∫–æ–º –æ—Å—Ç–∞–µ—Ç—Å—è –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–∞—É–∑ (EER = 0.383), –∫–æ—Ç–æ—Ä—ã–π –Ω–µ —Ç—Ä–µ–±–æ–≤–∞–ª –∏–Ω–≤–µ—Ä—Å–∏–∏, –≤ —Ç–æ –≤—Ä–µ–º—è –∫–∞–∫ –≤—Å–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ F0 –∏ —Ä–∏—Ç–º–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞–±–æ—Ç–∞–ª–∏ –≤ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∏ –ø–æ—Å–ª–µ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ EER –æ–∫–æ–ª–æ 0.46-0.49. –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —É–ª—É—á—à–µ–Ω–∏—è, –≤—Å–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Å–ª–∞–±—ã–º–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞–º–∏ (–ª—É—á—à–∏–π EER = 0.383, —Å—Ä–µ–¥–Ω–∏–π = 0.463), —á—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π –¥–µ—Ç–µ–∫—Ü–∏–∏ –¥–∏–ø—Ñ–µ–π–∫–æ–≤.

# –ß–∞—Å—Ç—å 3: Random Forest

## –°–æ–∑–¥–∞–Ω–∏–µ –∏ –æ–±—É—á–µ–Ω–∏–µ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏

–ü—Ä–æ–≤–µ—Ä–∫–∞, —É–ª—É—á—à–∏—Ç—Å—è –ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
"""

from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import cross_val_score, StratifiedKFold
from sklearn.metrics import roc_auc_score, roc_curve, confusion_matrix
import numpy as np

def create_combined_model(features_df, final_results_df):
    """
    –°–æ–∑–¥–∞–Ω–∏–µ –∏ –æ–±—É—á–µ–Ω–∏–µ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
    """


    # –í—ã–±–∏—Ä–∞–µ–º —Ç–æ–ø-5 –ª—É—á—à–∏—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
    top5_features = final_results_df.nsmallest(5, '–õ—É—á—à–∏–π EER')

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
    feature_name_map = {v: k for k, v in readable_feature_names.items()}
    selected_features = []

    for readable_name in top5_features['–ü—Ä–∏–∑–Ω–∞–∫']:
        tech_name = feature_name_map.get(readable_name)
        if tech_name and tech_name in features_df.columns:
            selected_features.append(tech_name)

    print(f"–í—ã–±—Ä–∞–Ω–æ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –¥–ª—è –º–æ–¥–µ–ª–∏: {len(selected_features)}")
    print("\n–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏:")
    for i, feature in enumerate(selected_features, 1):
        readable = readable_feature_names.get(feature, feature)
        eer = final_results_df[final_results_df['–ü—Ä–∏–∑–Ω–∞–∫'] == readable]['–õ—É—á—à–∏–π EER'].values[0]
        print(f"  {i}. {readable[:50]:50s} EER = {eer:.3f}")

    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    X = features_df[selected_features]
    y = (features_df['label'] == 'fake').astype(int)

    print()
    print(f"–†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö: {X.shape}")
    print(f"  –û–±—Ä–∞–∑—Ü–æ–≤: {X.shape[0]}")
    print(f"  –ü—Ä–∏–∑–Ω–∞–∫–æ–≤: {X.shape[1]}")
    print(f"  Real: {(y == 0).sum()}")
    print(f"  Fake: {(y == 1).sum()}")
    print()

    # –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏
    model = RandomForestClassifier(
        n_estimators=100,
        max_depth=10,
        min_samples_split=5,
        random_state=42,
        n_jobs=-1
    )

    # –ö—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏—è
    print("–û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ —Å –∫—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏–µ–π (5 —Ñ–æ–ª–¥–æ–≤)...")
    cv = StratifiedKFold(n_splits=5, shuffle=True, random_state=42)

    roc_auc_scores = cross_val_score(model, X, y, cv=cv, scoring='roc_auc', n_jobs=-1)

    print()
    print("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏–∏:")

    print(f"ROC-AUC –ø–æ —Ñ–æ–ª–¥–∞–º: {[f'{s:.3f}' for s in roc_auc_scores]}")
    print(f"–°—Ä–µ–¥–Ω–∏–π ROC-AUC: {roc_auc_scores.mean():.3f} ¬± {roc_auc_scores.std():.3f}")

    # –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π EER –∏–∑ ROC-AUC
    estimated_eer = 1 - roc_auc_scores.mean()
    print(f"–ü—Ä–∏–º–µ—Ä–Ω—ã–π EER: {estimated_eer:.3f} ({estimated_eer*100:.1f}% –æ—à–∏–±–æ–∫)")
    print()

    # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –æ–¥–∏–Ω–æ—á–Ω—ã–º–∏ –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏
    best_single_eer = final_results_df['–õ—É—á—à–∏–π EER'].min()
    improvement = best_single_eer - estimated_eer
    improvement_pct = (improvement / best_single_eer) * 100

    print("–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –æ–¥–∏–Ω–æ—á–Ω—ã–º–∏ –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏:")

    print(f"–õ—É—á—à–∏–π –æ–¥–∏–Ω–æ—á–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫: EER = {best_single_eer:.3f}")
    print(f"–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å:   EER ‚âà {estimated_eer:.3f}")
    print(f"–£–ª—É—á—à–µ–Ω–∏–µ:                {improvement:.3f} ({improvement_pct:+.1f}%)")

    if improvement > 0:
        print("–í—ã–≤–æ–¥: –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª—É—á—à–µ!")
    else:
        print("–í—ã–≤–æ–¥: –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –Ω–µ –¥–∞–ª–∞ —É–ª—É—á—à–µ–Ω–∏—è")
    print()

    # –û–±—É—á–µ–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è feature importance
    model.fit(X, y)

    return model, selected_features, roc_auc_scores

# –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏
rf_model, selected_features, cv_scores = create_combined_model(features_df, final_results_df)

"""–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ 5 –ª—É—á—à–∏—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –≤ –º–æ–¥–µ–ª—å Random Forest –¥–∞–ª–æ –¥–≤—É–∫—Ä–∞—Ç–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏:

- EER —Å–Ω–∏–∑–∏–ª—Å—è —Å 0.383 (–ª—É—á—à–∏–π –æ–¥–∏–Ω–æ—á–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫) –¥–æ 0.195, —á—Ç–æ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ 49%.
- –ú–æ–¥–µ–ª—å –¥–æ—Å—Ç–∏–≥–ª–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ ROC-AUC = 0.805 ¬± 0.036 –ø—Ä–∏ –∫—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞ 872 –æ–±—Ä–∞–∑—Ü–∞—Ö, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (—Ä–∞–∑–±—Ä–æ—Å –ø–æ —Ñ–æ–ª–¥–∞–º 0.775-0.871).

–≠—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç, —á—Ç–æ –¥–∞–∂–µ —Å–ª–∞–±—ã–µ –æ–¥–∏–Ω–æ—á–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ (EER 0.38-0.46) –≤ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ —Å–æ–∑–¥–∞—é—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –¥–µ—Ç–µ–∫—Ç–æ—Ä, —Å–ø–æ—Å–æ–±–Ω—ã–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –æ–∫–æ–ª–æ 80% —Å–ª—É—á–∞–µ–≤.

–í –º–æ–¥–µ–ª—å –≤–æ—à–ª–∏ 5 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π:

- –ü–∞—É–∑—ã: –í–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–∞—É–∑ (EER = 0.383)
- –ì—Ä–æ–º–∫–æ—Å—Ç—å: –ò–∑–º–µ–Ω—á–∏–≤–æ—Å—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç–∏ (EER = 0.431)
- –°–ø–µ–∫—Ç—Ä: –°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–ø–µ–∫—Ç—Ä–∞ (EER = 0.454)
- –†–∏—Ç–º–∏–∫–∞: –°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–∏–∑–Ω–µ—Å–µ–Ω–∏—è (EER = 0.461, –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
- –†–∏—Ç–º–∏–∫–∞: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—á–µ–≤—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É (EER = 0.463, –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)

–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –º–æ–¥–µ–ª—å –æ–±—ä–µ–¥–∏–Ω–∏–ª–∞ –ø—Ä–∏–∑–Ω–∞–∫–∏ –∏–∑ —á–µ—Ç—ã—Ä–µ—Ö –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –∞–∫—É—Å—Ç–∏—á–µ—Å–∫–∏—Ö –¥–æ–º–µ–Ω–æ–≤ (–ø–∞—É–∑—ã, –≥—Ä–æ–º–∫–æ—Å—Ç—å, —Å–ø–µ–∫—Ç—Ä, —Ä–∏—Ç–º–∏–∫–∞), –ø—Ä–∏—á–µ–º –¥–≤–∞ –∏–∑ –Ω–∏—Ö –ø–æ—Ç—Ä–µ–±–æ–≤–∞–ª–∏ –∏–Ω–≤–µ—Ä—Å–∏–∏. –°–∏–Ω–µ—Ä–≥–∏—è —Ä–∞–∑–Ω–æ—Ä–æ–¥–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –ø–æ–∑–≤–æ–ª–∏–ª–∞ –º–æ–¥–µ–ª–∏ —É–ª–æ–≤–∏—Ç—å –º–Ω–æ–≥–æ–º–µ—Ä–Ω—É—é "—Å–∏–≥–Ω–∞—Ç—É—Ä—É" –¥–∏–ø—Ñ–µ–π–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ–≤–∏–¥–∏–º–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∫–∞–∂–¥–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏ - –∫–∞–∂–¥—ã–π –ø—Ä–∏–∑–Ω–∞–∫ –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å–≤–æ–π –∞—Å–ø–µ–∫—Ç —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–æ–π —Ä–µ—á–∏ (–º–µ—Ö–∞–Ω–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å –ø–∞—É–∑, –∏–∑–±—ã—Ç–æ—á–Ω–∞—è –¥–∏–Ω–∞–º–∏–∫–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏, —Å–ø–µ–∫—Ç—Ä–∞–ª—å–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã, —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å), –∏ –≤–º–µ—Å—Ç–µ –æ–Ω–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç –Ω–∞–¥–µ–∂–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏.

## –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞
"""

from sklearn.metrics import accuracy_score, precision_score, recall_score, f1_score
from sklearn.model_selection import cross_validate, StratifiedKFold

def evaluate_model_metrics(rf_model, selected_features, features_df):
    """
    –†–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫ –∫–∞—á–µ—Å—Ç–≤–∞ –º–æ–¥–µ–ª–∏
    """
    y = (features_df['label'] == 'fake').astype(int)
    X = features_df[selected_features]

    # –ö—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏—è
    cv = StratifiedKFold(n_splits=5, shuffle=True, random_state=42)

    scoring = {
        'accuracy': 'accuracy',
        'precision': 'precision',
        'recall': 'recall',
        'f1': 'f1',
        'roc_auc': 'roc_auc'
    }

    cv_results = cross_validate(rf_model, X, y, cv=cv, scoring=scoring, n_jobs=-1)

    print(f"Accuracy:  {cv_results['test_accuracy'].mean():.3f} ¬± {cv_results['test_accuracy'].std():.3f}")
    print(f"Precision: {cv_results['test_precision'].mean():.3f} ¬± {cv_results['test_precision'].std():.3f}")
    print(f"Recall:    {cv_results['test_recall'].mean():.3f} ¬± {cv_results['test_recall'].std():.3f}")
    print(f"F1-Score:  {cv_results['test_f1'].mean():.3f} ¬± {cv_results['test_f1'].std():.3f}")
    print(f"ROC-AUC:   {cv_results['test_roc_auc'].mean():.3f} ¬± {cv_results['test_roc_auc'].std():.3f}")

evaluate_model_metrics(rf_model, selected_features, features_df)

from sklearn.metrics import classification_report
from sklearn.model_selection import cross_val_predict, StratifiedKFold

def evaluate_by_class(rf_model, selected_features, features_df):
    """
    –ú–µ—Ç—Ä–∏–∫–∏ –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è Real –∏ Fake
    """
    y = (features_df['label'] == 'fake').astype(int)
    X = features_df[selected_features]

    cv = StratifiedKFold(n_splits=5, shuffle=True, random_state=42)
    y_pred = cross_val_predict(rf_model, X, y, cv=cv)

    print(classification_report(y, y_pred,
                                target_names=['Real', 'Fake'],
                                digits=3))

evaluate_by_class(rf_model, selected_features, features_df)

"""–ú–æ–¥–µ–ª—å –Ω–µ–º–Ω–æ–≥–æ –ª—É—á—à–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç Real (F1=0.736), —á–µ–º Fake (F1=0.717). –û–Ω–∞ —á–∞—â–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –¥–∏–ø—Ñ–µ–π–∫–∏ (recall=0.693), —á–µ–º –æ—à–∏–±–æ—á–Ω–æ –ø–æ–º–µ—á–∞–µ—Ç –Ω–∞—Å—Ç–æ—è—â—É—é —Ä–µ—á—å –∫–∞–∫ fake. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –º–æ–¥–µ–ª—å "–æ—Å—Ç–æ—Ä–æ–∂–Ω–∞" –∏ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç –Ω–µ –æ–±–≤–∏–Ω—è—Ç—å –±–µ–∑ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏, —á—Ç–æ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–æ–¥–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞) –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ, —á–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç–æ—è—â—É—é —Ä–µ—á—å."""

import matplotlib.pyplot as plt
import seaborn as sns

def visualize_combined_model(rf_model, selected_features, cv_scores, features_df, readable_names):
    """
    –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
    """

    fig, axes = plt.subplots(2, 2, figsize=(16, 12))

    # –ì—Ä–∞—Ñ–∏–∫ 1: Feature Importance
    ax1 = axes[0, 0]

    importances = rf_model.feature_importances_
    feature_names_readable = [readable_names.get(f, f)[:35] for f in selected_features]

    indices = np.argsort(importances)[::-1]

    colors = plt.cm.viridis(np.linspace(0.3, 0.9, len(importances)))
    bars = ax1.barh(range(len(importances)), importances[indices], color=colors)
    ax1.set_yticks(range(len(importances)))
    ax1.set_yticklabels([feature_names_readable[i] for i in indices])
    ax1.set_xlabel('–í–∞–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–∞')
    ax1.set_title('Feature Importance –≤ Random Forest', fontweight='bold', fontsize=12)
    ax1.invert_yaxis()

    for i, (bar, imp) in enumerate(zip(bars, importances[indices])):
        ax1.text(bar.get_width() + 0.01, bar.get_y() + bar.get_height()/2,
                f'{imp:.3f}', va='center', fontsize=10)

    # –ì—Ä–∞—Ñ–∏–∫ 2: ROC Curves –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–æ–ª–¥–∞
    ax2 = axes[0, 1]

    y = (features_df['label'] == 'fake').astype(int)
    X = features_df[selected_features]

    cv = StratifiedKFold(n_splits=5, shuffle=True, random_state=42)

    tprs = []
    aucs = []
    mean_fpr = np.linspace(0, 1, 100)

    for fold_idx, (train_idx, test_idx) in enumerate(cv.split(X, y)):
        X_train, X_test = X.iloc[train_idx], X.iloc[test_idx]
        y_train, y_test = y.iloc[train_idx], y.iloc[test_idx]

        rf_model.fit(X_train, y_train)
        y_pred_proba = rf_model.predict_proba(X_test)[:, 1]

        fpr, tpr, _ = roc_curve(y_test, y_pred_proba)
        roc_auc = roc_auc_score(y_test, y_pred_proba)

        aucs.append(roc_auc)
        tprs.append(np.interp(mean_fpr, fpr, tpr))
        tprs[-1][0] = 0.0

        ax2.plot(fpr, tpr, lw=1, alpha=0.3, label=f'Fold {fold_idx+1} (AUC = {roc_auc:.3f})')

    mean_tpr = np.mean(tprs, axis=0)
    mean_tpr[-1] = 1.0
    mean_auc = np.mean(aucs)
    std_auc = np.std(aucs)

    ax2.plot(mean_fpr, mean_tpr, color='b', lw=2,
            label=f'–°—Ä–µ–¥–Ω–µ–µ (AUC = {mean_auc:.3f} ¬± {std_auc:.3f})')
    ax2.plot([0, 1], [0, 1], 'k--', lw=1, label='–°–ª—É—á–∞–π–Ω–æ–µ —É–≥–∞–¥—ã–≤–∞–Ω–∏–µ')

    ax2.set_xlabel('False Positive Rate')
    ax2.set_ylabel('True Positive Rate')
    ax2.set_title('ROC Curves (–∫—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏—è)', fontweight='bold', fontsize=12)
    ax2.legend(loc='lower right', fontsize=8)
    ax2.grid(True, alpha=0.3)

    # –ì—Ä–∞—Ñ–∏–∫ 3: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤
    ax3 = axes[1, 0]

    methods = ['–õ—É—á—à–∏–π\n–æ–¥–∏–Ω–æ—á–Ω—ã–π\n–ø—Ä–∏–∑–Ω–∞–∫', '–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è\n–º–æ–¥–µ–ª—å\n(5 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤)']
    eer_values = [0.383, 0.195]
    colors_comparison = ['orange', 'green']

    bars = ax3.bar(methods, eer_values, color=colors_comparison, alpha=0.7, edgecolor='black')
    ax3.axhline(y=0.5, color='red', linestyle='--', alpha=0.5, label='–°–ª—É—á–∞–π–Ω–æ–µ —É–≥–∞–¥—ã–≤–∞–Ω–∏–µ')
    ax3.set_ylabel('Equal Error Rate (EER)')
    ax3.set_title('–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤', fontweight='bold', fontsize=12)
    ax3.set_ylim(0, 0.6)
    ax3.legend()
    ax3.grid(True, alpha=0.3, axis='y')

    for bar, eer in zip(bars, eer_values):
        height = bar.get_height()
        ax3.text(bar.get_x() + bar.get_width()/2., height + 0.01,
                f'{eer:.3f}\n({eer*100:.1f}%)',
                ha='center', va='bottom', fontsize=11, fontweight='bold')

    # –ì—Ä–∞—Ñ–∏–∫ 4: Confusion Matrix
    ax4 = axes[1, 1]

    rf_model.fit(X, y)
    y_pred = rf_model.predict(X)

    cm = confusion_matrix(y, y_pred)

    sns.heatmap(cm, annot=True, fmt='d', cmap='Blues', ax=ax4,
                xticklabels=['Real', 'Fake'],
                yticklabels=['Real', 'Fake'],
                cbar_kws={'label': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'})

    ax4.set_xlabel('–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω–∞—è –º–µ—Ç–∫–∞')
    ax4.set_ylabel('–ò—Å—Ç–∏–Ω–Ω–∞—è –º–µ—Ç–∫–∞')
    ax4.set_title('Confusion Matrix\n(–æ–±—É—á–µ–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö)', fontweight='bold', fontsize=12)

    accuracy = (cm[0, 0] + cm[1, 1]) / cm.sum()
    ax4.text(0.5, -0.15, f'–¢–æ—á–Ω–æ—Å—Ç—å: {accuracy:.1%}',
            ha='center', transform=ax4.transAxes, fontsize=11)

    plt.suptitle('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ Random Forest',
                fontsize=14, fontweight='bold', y=0.995)
    plt.tight_layout()
    plt.savefig('/content/combined_model_results.png', dpi=300, bbox_inches='tight')
    plt.show()

# –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
visualize_combined_model(rf_model, selected_features, cv_scores, features_df, readable_feature_names)

"""## –ê–Ω–∞–ª–∏–∑

- Feature Importance: –ú–æ–¥–µ–ª—å –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—á–µ–≤—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –∫–∞–∫ –¥–æ–º–∏–Ω–∏—Ä—É—é—â–∏–π –ø—Ä–∏–∑–Ω–∞–∫ (33% –≤–∞–∂–Ω–æ—Å—Ç–∏), –ø—Ä–∏ —ç—Ç–æ–º –≤—Å–µ –ø—è—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –≤–Ω–æ—Å—è—Ç –≤–∫–ª–∞–¥ –≤ —Ä–µ—à–µ–Ω–∏–µ, —á—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –º–Ω–æ–≥–æ–º–µ—Ä–Ω—É—é –ø—Ä–∏—Ä–æ–¥—É –¥–µ—Ç–µ–∫—Ü–∏–∏ –¥–∏–ø—Ñ–µ–π–∫–æ–≤.

- ROC Curves: –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è —É–∑–∫–∏–º —Ä–∞–∑–±—Ä–æ—Å–æ–º AUC –ø–æ —Ñ–æ–ª–¥–∞–º (0.775-0.815) —Å–æ —Å—Ä–µ–¥–Ω–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º 0.805, —á—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–≤—ã—à–∞–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ —É–≥–∞–¥—ã–≤–∞–Ω–∏–µ –∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∫—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏–∏.

- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å —Å–Ω–∏–∑–∏–ª–∞ –æ—à–∏–±–∫—É –ø–æ—á—Ç–∏ –≤–¥–≤–æ–µ (—Å 38.3% –¥–æ 19.5%), –Ω–∞–≥–ª—è–¥–Ω–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—è –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ –º–Ω–æ–≥–æ–º–µ—Ä–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞–¥ –æ–¥–∏–Ω–æ—á–Ω—ã–º–∏ –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏.

- Confusion Matrix: –¢–æ—á–Ω–æ—Å—Ç—å 98.2% –Ω–∞ –æ–±—É—á–∞—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç–ª–∏—á–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ –∫ –æ–±—É—á–µ–Ω–∏—é, –ø—Ä–∏ —ç—Ç–æ–º –∞—Å–∏–º–º–µ—Ç—Ä–∏—è –æ—à–∏–±–æ–∫ (6 –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π vs 10 –ø—Ä–æ–ø—É—Å–∫–æ–≤) —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –Ω–µ–±–æ–ª—å—à—É—é —Ç–µ–Ω–¥–µ–Ω—Ü–∏—é –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –¥–∏–ø—Ñ–µ–π–∫–∏

# –ß–∞—Å—Ç—å 4: —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ fastpitch –∏ vits

FastPitch –∏ VITS ‚Äî —ç—Ç–æ –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–≤—ã—Ö TTS‚Äë—Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä–æ–≤ (Text‚Äëto‚ÄëSpeech), —Ç–æ –µ—Å—Ç—å –º–æ–¥–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç —Ä–µ—á—å –∏–∑ —Ç–µ–∫—Å—Ç–∞: FastPitch –æ–±—ã—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –¥–≤–∞ —à–∞–≥–∞ (—Å–Ω–∞—á–∞–ª–∞ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã—Å–æ—Ç—É —Ç–æ–Ω–∞/–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç ‚Äú–º–µ–ª‚Äë—Å–ø–µ–∫—Ç—Ä–æ–≥—Ä–∞–º–º—É‚Äù, –∑–∞—Ç–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –≤–æ–∫–æ–¥–µ—Ä –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –µ—ë –≤ –∑–≤—É–∫) –∏ –ø–æ—ç—Ç–æ–º—É —á–∞—Å—Ç–æ –¥–∞–µ—Ç –±–æ–ª–µ–µ ‚Äú–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—É—é‚Äù, –Ω–æ –º–µ—Å—Ç–∞–º–∏ –±–æ–ª–µ–µ –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫—É—é –ø—Ä–æ—Å–æ–¥–∏—é, –∞ VITS ‚Äî –±–æ–ª–µ–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è end‚Äëto‚Äëend –º–æ–¥–µ–ª—å, –∫–æ—Ç–æ—Ä–∞—è –≤ –æ–¥–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ —Å–æ–≤–º–µ—Å—Ç–Ω–æ —É—á–∏—Ç —Ç–µ–∫—Å—Ç‚Üí—Ä–µ—á—å –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∞—É–¥–∏–æ (—á–µ—Ä–µ–∑ –≤–∞—Ä–∏–∞—Ü–∏–æ–Ω–Ω—ã–π/flow‚Äë–ø–æ–¥—Ö–æ–¥), –∏–∑‚Äë–∑–∞ —á–µ–≥–æ —á–∞—Å—Ç–æ –∑–≤—É—á–∏—Ç –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏ –ø–ª–∞–≤–Ω–æ, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –º–æ–∂–µ—Ç –æ—Å—Ç–∞–≤–ª—è—Ç—å —Å–≤–æ–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã.
"""

from google.colab import files
import zipfile
import os
import glob
import shutil

def upload_and_prepare_data():
    """
    –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∞—É–¥–∏–æ –¥–ª—è —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
    """
    print("üì§ –ó–∞–≥—Ä—É–∑–∏—Ç–µ 3 –∞—Ä—Ö–∏–≤–∞:")
    print("   1. natural.zip")
    print("   2. fastpitch-hifigan.zip (–∏–ª–∏ fastpitch.zip)")
    print("   3. vits.zip")
    print()

    uploaded = files.upload()

    # –°–æ–∑–¥–∞–Ω–∏–µ —á–∏—Å—Ç—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
    dirs = {
        'natural': '/content/audio_natural',
        'fastpitch': '/content/audio_fastpitch',
        'vits': '/content/audio_vits'
    }

    for path in dirs.values():
        if os.path.exists(path):
            shutil.rmtree(path)
        os.makedirs(path, exist_ok=True)

    # –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —Ç–∏–ø–∞
    for filename in uploaded.keys():
        filepath = os.path.join('/content', filename)
        fn_lower = filename.lower()

        print(f"–û–±—Ä–∞–±–æ—Ç–∫–∞: {filename}")

        if 'natural' in fn_lower or '–Ω–∞—Ç—É—Ä' in fn_lower:
            with zipfile.ZipFile(filepath, 'r') as zip_ref:
                zip_ref.extractall(dirs['natural'])
            print(f"  ‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ –∫–∞–∫: Natural")

        elif 'fastpitch' in fn_lower or 'fast' in fn_lower:
            with zipfile.ZipFile(filepath, 'r') as zip_ref:
                zip_ref.extractall(dirs['fastpitch'])
            print(f"  ‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ –∫–∞–∫: FastPitch")

        elif 'vits' in fn_lower:
            with zipfile.ZipFile(filepath, 'r') as zip_ref:
                zip_ref.extractall(dirs['vits'])
            print(f"  ‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ –∫–∞–∫: VITS")
        else:
            print(f"  ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø")

    # –ü–æ–¥—Å—á–µ—Ç —Ñ–∞–π–ª–æ–≤
    print("\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:")
    counts = {}
    for name, path in dirs.items():
        wav_files = glob.glob(f"{path}/**/*.wav", recursive=True)
        counts[name] = len(wav_files)
        print(f"   {name:12s}: {counts[name]:4d} .wav —Ñ–∞–π–ª–æ–≤")

    return dirs['natural'], dirs['fastpitch'], dirs['vits']


def create_paired_dataframe(natural_dir, fastpitch_dir, vits_dir):
    """
    –°–æ–∑–¥–∞–Ω–∏–µ DataFrame —Ç–æ–ª—å–∫–æ –∏–∑ –ø–∞—Ä–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    """
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–∫–∏ —Ñ–∞–π–ª–æ–≤
    natural_files = {os.path.basename(f): f
                     for f in glob.glob(f"{natural_dir}/**/*.wav", recursive=True)}
    fastpitch_files = {os.path.basename(f): f
                       for f in glob.glob(f"{fastpitch_dir}/**/*.wav", recursive=True)}
    vits_files = {os.path.basename(f): f
                  for f in glob.glob(f"{vits_dir}/**/*.wav", recursive=True)}

    print(f"\nüîç –ü–æ–∏—Å–∫ –ø–∞—Ä–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:")
    print(f"   Natural:   {len(natural_files)} —Ñ–∞–π–ª–æ–≤")
    print(f"   FastPitch: {len(fastpitch_files)} —Ñ–∞–π–ª–æ–≤")
    print(f"   VITS:      {len(vits_files)} —Ñ–∞–π–ª–æ–≤")

    # –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ (—Ñ–∞–π–ª—ã —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –∏–º–µ–Ω–∞–º–∏)
    paired_filenames = (set(natural_files.keys()) &
                        set(fastpitch_files.keys()) &
                        set(vits_files.keys()))

    print(f"\n‚úÖ –ü–∞—Ä–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (–ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤–æ –≤—Å–µ—Ö 3 –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö): {len(paired_filenames)}")

    if len(paired_filenames) == 0:
        print("\n‚ùå –û–®–ò–ë–ö–ê: –ü–∞—Ä–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!")
        print("   –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
        print("   - –†–∞–∑–Ω—ã–µ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –≤ —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö")
        print("   - –§–∞–π–ª—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ø–æ–¥–ø–∞–ø–∫–∞—Ö —Å —Ä–∞–∑–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π")

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        print("\n   –ü—Ä–∏–º–µ—Ä—ã –∏–º–µ–Ω —Ñ–∞–π–ª–æ–≤:")
        print(f"   Natural:   {list(natural_files.keys())[:3]}")
        print(f"   FastPitch: {list(fastpitch_files.keys())[:3]}")
        print(f"   VITS:      {list(vits_files.keys())[:3]}")
        return None

    # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å–∏
    data_records = []

    for filename in sorted(paired_filenames):
        # Natural
        data_records.append({
            'file_path': natural_files[filename],
            'label': 'real',
            'synthesis_type': 'real',
            'filename': filename
        })

        # FastPitch
        data_records.append({
            'file_path': fastpitch_files[filename],
            'label': 'fake',
            'synthesis_type': 'fastpitch',
            'filename': filename
        })

        # VITS
        data_records.append({
            'file_path': vits_files[filename],
            'label': 'fake',
            'synthesis_type': 'vits',
            'filename': filename
        })

    df = pd.DataFrame(data_records)

    print(f"\nüìã DataFrame —Å–æ–∑–¥–∞–Ω:")
    print(df['synthesis_type'].value_counts())
    print(f"\n   –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {len(df)}")
    print(f"   –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ñ—Ä–∞–∑: {len(paired_filenames)}")

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä
    print(f"\nüëÄ –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö (–ø–µ—Ä–≤—ã–µ 9 —Å—Ç—Ä–æ–∫ = 3 —Ñ—Ä–∞–∑—ã √ó 3 –≤–µ—Ä—Å–∏–∏):")
    print(df[['filename', 'synthesis_type', 'label']].head(9))

    return df


# üöÄ –ó–ê–ü–£–°–ö
print("="*70)
print("–ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –î–õ–Ø –ó–ê–î–ê–ù–ò–Ø")
print("="*70)
print()

# –ó–∞–≥—Ä—É–∑–∫–∞
natural_path, fastpitch_path, vits_path = upload_and_prepare_data()

# –°–æ–∑–¥–∞–Ω–∏–µ DataFrame
audio_df = create_paired_dataframe(natural_path, fastpitch_path, vits_path)

if audio_df is not None:
    print("\n" + "="*70)
    print("‚úÖ –î–ê–ù–ù–´–ï –ì–û–¢–û–í–´ –ö –ê–ù–ê–õ–ò–ó–£!")
    print("="*70)

"""## –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ OpenSMILE"""

import subprocess
import os

def setup_opensmile():
    """
    –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–±–æ—Ä–∫–∞ openSMILE
    """

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è
    if os.path.exists('/content/opensmile/build/progsrc/smilextract/SMILExtract'):
        print("OpenSMILE —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        return True

    # –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    if not os.path.exists('/content/opensmile'):
        print("–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è...")
        result = subprocess.run(
            ['git', 'clone', 'https://github.com/audeering/opensmile.git'],
            cwd='/content',
            capture_output=True,
            text=True
        )
        if result.returncode != 0:
            print("–û—à–∏–±–∫–∞ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è")
            print(result.stderr)
            return False
        print("–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω")

    # –°–±–æ—Ä–∫–∞
    print("–°–±–æ—Ä–∫–∞ OpenSMILE (—ç—Ç–æ –∑–∞–π–º–µ—Ç ~2-3 –º–∏–Ω—É—Ç—ã)...")
    result = subprocess.run(
        ['bash', 'build.sh'],
        cwd='/content/opensmile',
        capture_output=True,
        text=True
    )

    if result.returncode == 0:
        print("OpenSMILE —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω!")
        return True
    else:
        print(" –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏")
        print(result.stderr)
        return False

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞
setup_opensmile()

import subprocess
from tqdm import tqdm
import pandas as pd
import os

def extract_features_three_types(audio_df):
    """
    –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ eGeMAPSv02 –¥–ª—è –≤—Å–µ—Ö —Ç—Ä–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    """
    smile_path = "/content/opensmile/build/progsrc/smilextract/SMILExtract"
    config_path = "/content/opensmile/config/egemaps/v02/eGeMAPSv02.conf"

    features_list = []

    print("–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∞–∫—É—Å—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤...")
    print(f"–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: {len(audio_df)}")

    for idx, row in tqdm(audio_df.iterrows(), total=len(audio_df), desc="–û–±—Ä–∞–±–æ—Ç–∫–∞"):
        audio_file = row['file_path']
        temp_csv = f"/content/temp_features_{idx}.csv"

        cmd = [
            smile_path,
            '-C', config_path,
            '-I', audio_file,
            '-O', temp_csv,
            '-l', '0'
        ]

        try:
            result = subprocess.run(cmd, capture_output=True, text=True, timeout=120)

            if result.returncode == 0 and os.path.exists(temp_csv):
                with open(temp_csv, 'r') as f:
                    content = f.read()

                if '@data' in content:
                    data_line = content.split('@data')[-1].strip().split('\n')[0]
                    values = data_line.split(',')

                    if len(values) > 50:
                        features = {}
                        for i, val in enumerate(values[1:], 1):
                            try:
                                features[f'feature_{i}'] = float(val)
                            except:
                                features[f'feature_{i}'] = val

                        features['label'] = row['label']
                        features['synthesis_type'] = row['synthesis_type']
                        features['filename'] = row['filename']
                        features_list.append(features)

                os.remove(temp_csv)

        except Exception as e:
            continue

    features_df = pd.DataFrame(features_list)

    print(f"\n –ò–∑–≤–ª–µ—á–µ–Ω–æ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤: {len(features_df)} –∑–∞–ø–∏—Å–µ–π")
    print(f" –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:")
    print(features_df['synthesis_type'].value_counts())

    return features_df

features_df = extract_features_three_types(audio_df)

"""## –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∞–Ω–∞–ª–∏–∑—É"""

import numpy as np
from sklearn.metrics import roc_curve

# 1. –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
def get_feature_names():
    """
    –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –∏–∑ ARFF —Ñ–∞–π–ª–∞
    """
    smile_path = "/content/opensmile/build/progsrc/smilextract/SMILExtract"
    config_path = "/content/opensmile/config/egemaps/v02/eGeMAPSv02.conf"
    test_audio = audio_df.iloc[0]['file_path']
    test_arff = "/content/feature_names.arff"

    cmd = [smile_path, '-C', config_path, '-I', test_audio, '-O', test_arff]
    subprocess.run(cmd, capture_output=True, text=True)

    feature_names = []
    if os.path.exists(test_arff):
        with open(test_arff, 'r') as f:
            for line in f:
                if line.startswith('@attribute') and 'numeric' in line:
                    name = line.split()[1]
                    feature_names.append(name)

    return feature_names

# 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏–π
feature_names = get_feature_names()

# 3. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫
rename_dict = {f'feature_{i}': feature_names[i-1]
               for i in range(1, len(feature_names) + 1)
               if i <= len(feature_names)}
features_df = features_df.rename(columns=rename_dict)

# 4. –°–ª–æ–≤–∞—Ä—å —á–∏—Ç–∞–µ–º—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π
readable_feature_names = {
    'F0semitoneFrom27.5Hz_sma3nz_amean': '–°—Ä–µ–¥–Ω—è—è –≤—ã—Å–æ—Ç–∞ –≥–æ–ª–æ—Å–∞',
    'F0semitoneFrom27.5Hz_sma3nz_stddevNorm': '–ò–∑–º–µ–Ω—á–∏–≤–æ—Å—Ç—å –≤—ã—Å–æ—Ç—ã –≥–æ–ª–æ—Å–∞',
    'F0semitoneFrom27.5Hz_sma3nz_meanRisingSlope': '–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–≤—ã—à–µ–Ω–∏—è –∏–Ω—Ç–æ–Ω–∞—Ü–∏–∏',
    'F0semitoneFrom27.5Hz_sma3nz_meanFallingSlope': '–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–Ω–∏–∂–µ–Ω–∏—è –∏–Ω—Ç–æ–Ω–∞—Ü–∏–∏',
    'loudness_sma3_amean': '–°—Ä–µ–¥–Ω—è—è –≥—Ä–æ–º–∫–æ—Å—Ç—å —Ä–µ—á–∏',
    'loudness_sma3_stddevNorm': '–ò–∑–º–µ–Ω—á–∏–≤–æ—Å—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç–∏',
    'loudness_sma3_stddevFallingSlope': '–í–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞—Ç—É—Ö–∞–Ω–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏',
    'MeanUnvoicedSegmentLength': '–°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–∞—É–∑',
    'StddevUnvoicedSegmentLength': '–í–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–∞—É–∑',
    'MeanVoicedSegmentLengthSec': '–°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–∏–∑–Ω–µ—Å–µ–Ω–∏—è',
    'VoicedSegmentsPerSec': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—á–µ–≤—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É',
    'loudnessPeaksPerSec': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ü–µ–Ω—Ç–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É',
    'spectralFlux_sma3_amean': '–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–ø–µ–∫—Ç—Ä–∞'
}

# 5. –°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
key_features = [
    'F0semitoneFrom27.5Hz_sma3nz_amean',
    'F0semitoneFrom27.5Hz_sma3nz_stddevNorm',
    'F0semitoneFrom27.5Hz_sma3nz_meanRisingSlope',
    'F0semitoneFrom27.5Hz_sma3nz_meanFallingSlope',
    'loudness_sma3_amean',
    'loudness_sma3_stddevNorm',
    'loudness_sma3_stddevFallingSlope',
    'MeanUnvoicedSegmentLength',
    'StddevUnvoicedSegmentLength',
    'MeanVoicedSegmentLengthSec',
    'VoicedSegmentsPerSec',
    'loudnessPeaksPerSec',
    'spectralFlux_sma3_amean'
]

# 6. –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ EER
def compute_eer(scores, labels):
    """
    –í—ã—á–∏—Å–ª–µ–Ω–∏–µ Equal Error Rate
    """
    fpr, tpr, thresholds = roc_curve(labels, scores, pos_label=1)
    fnr = 1 - tpr
    eer_index = np.nanargmin(np.absolute(fnr - fpr))
    eer = fpr[eer_index]
    threshold = thresholds[eer_index]
    return eer, threshold

print(f"   ‚Ä¢ –ó–∞–ø–∏—Å–µ–π: {len(features_df)}")
print(f"   ‚Ä¢ –ü—Ä–∏–∑–Ω–∞–∫–æ–≤: {len(feature_names)}")
print(f"   ‚Ä¢ –ö–ª—é—á–µ–≤—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞: {len(key_features)}")
print(f"   ‚Ä¢ Real: {(features_df['synthesis_type'] == 'real').sum()}")
print(f"   ‚Ä¢ FastPitch: {(features_df['synthesis_type'] == 'fastpitch').sum()}")
print(f"   ‚Ä¢ VITS: {(features_df['synthesis_type'] == 'vits').sum()}")

"""## –ê–Ω–∞–ª–∏–∑ Natural vs FastPitch"""

from tqdm import tqdm

def analyze_synthesis_pair(features_df, synthesis_type, key_features, readable_names):
    """
    –ê–Ω–∞–ª–∏–∑ –ø–∞—Ä—ã Natural vs –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∏–ø —Å–∏–Ω—Ç–µ–∑–∞ (FastPitch –∏–ª–∏ VITS)

    Args:
        synthesis_type: 'fastpitch' –∏–ª–∏ 'vits'
    """

    # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö: —Ç–æ–ª—å–∫–æ real –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø
    df_pair = features_df[
        (features_df['synthesis_type'] == 'real') |
        (features_df['synthesis_type'] == synthesis_type)
    ].copy()

    print(f"\n –†–∞–∑–º–µ—Ä –≤—ã–±–æ—Ä–∫–∏:")
    print(f"   Real: {(df_pair['synthesis_type'] == 'real').sum()}")
    print(f"   {synthesis_type.capitalize()}: {(df_pair['synthesis_type'] == synthesis_type).sum()}")

    # –ú–µ—Ç–∫–∏: 0 = real, 1 = fake
    labels = (df_pair['synthesis_type'] == synthesis_type).astype(int)

    # –ê–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–∑–Ω–∞–∫–∞
    results = {}

    print(f"\n –†–∞—Å—á–µ—Ç EER –¥–ª—è {len(key_features)} –ø—Ä–∏–∑–Ω–∞–∫–æ–≤...")

    for feature in tqdm(key_features, desc="EER —Ä–∞—Å—á–µ—Ç"):
        if feature not in df_pair.columns:
            continue

        scores = df_pair[feature].values

        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∫–ª–∞—Å—Å–∞–º
        real_values = df_pair[df_pair['synthesis_type'] == 'real'][feature]
        fake_values = df_pair[df_pair['synthesis_type'] == synthesis_type][feature]

        # –í—ã—á–∏—Å–ª–µ–Ω–∏–µ EER
        eer, threshold = compute_eer(scores, labels)

        diff = fake_values.mean() - real_values.mean()
        diff_pct = (abs(diff) / real_values.mean() * 100) if real_values.mean() != 0 else 0

        results[feature] = {
            'eer': eer,
            'threshold': threshold,
            'mean_real': real_values.mean(),
            'mean_fake': fake_values.mean(),
            'std_real': real_values.std(),
            'std_fake': fake_values.std(),
            'diff': diff,
            'diff_pct': diff_pct
        }

    # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ EER (–ª—É—á—à–∏–µ –ø–µ—Ä–≤—ã–µ)
    results = dict(sorted(results.items(), key=lambda x: x[1]['eer']))

    # –í—ã–≤–æ–¥ —Ç–æ–ø-5
    print(f"\n –¢–û–ü-5 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ {synthesis_type.upper()}:")
    for i, (feature, stats) in enumerate(list(results.items())[:5], 1):
        readable = readable_names.get(feature, feature)
        print(f"\n{i}. {readable}")
        print(f"   EER: {stats['eer']:.3f} ({stats['eer']*100:.1f}% –æ—à–∏–±–æ–∫)")
        print(f"   Real: {stats['mean_real']:.4f} ¬± {stats['std_real']:.4f}")
        print(f"   Fake: {stats['mean_fake']:.4f} ¬± {stats['std_fake']:.4f}")
        print(f"   –†–∞–∑–Ω–∏—Ü–∞: {stats['diff']:+.4f} ({stats['diff_pct']:+.1f}%)")

    return df_pair, results


# –ó–ê–ü–£–°–ö –ê–ù–ê–õ–ò–ó–ê FASTPITCH
df_fastpitch, results_fastpitch = analyze_synthesis_pair(
    features_df,
    'fastpitch',
    key_features,
    readable_feature_names
)

"""–ê–Ω–∞–ª–∏–∑:
1. –ö–∞—á–µ—Å—Ç–≤–æ —Å–∏–Ω—Ç–µ–∑–∞: FastPitch –∏–º–∏—Ç–∏—Ä—É–µ—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—É—é —Ä–µ—á—å –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ ‚Äî –ª—É—á—à–∏–π –ø—Ä–∏–∑–Ω–∞–∫ –¥–∞–µ—Ç —Ç–æ–ª—å–∫–æ 38.7% —Ç–æ—á–Ω–æ—Å—Ç–∏.

2. –ì–ª–∞–≤–Ω–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å: –ú–µ—Ö–∞–Ω–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å –ø–∞—É–∑

- FastPitch –¥–µ–ª–∞–µ—Ç –ø–∞—É–∑—ã –Ω–∞ 13.7% –±–æ–ª–µ–µ –æ–¥–Ω–æ—Ä–æ–¥–Ω—ã–º–∏
- –≠—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫ —Å EER < 40%

3. –ü–∞—Ç—Ç–µ—Ä–Ω —Ä–∞–∑–ª–∏—á–∏–π:

- –•–æ—Ä–æ—à–æ –∏–º–∏—Ç–∏—Ä—É–µ—Ç—Å—è: —Å–ø–µ–∫—Ç—Ä (+1.9%), –≥—Ä–æ–º–∫–æ—Å—Ç—å (+3.5%)
- –°–ª–∞–±–æ–µ –º–µ—Å—Ç–æ: –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–ø–∞—É–∑—ã +13.7%, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å +4.3%)

–û–¥–∏–Ω–æ—á–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ FastPitch. –°–∏—Å—Ç–µ–º–∞ —Å–∏–Ω—Ç–µ–∑–∏—Ä—É–µ—Ç —Ä–µ—á—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ, —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞–º–∏ —Ç–æ–ª—å–∫–æ –≤ —Ä–∏—Ç–º–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ.


"""

df_vits, results_vits = analyze_synthesis_pair(
    features_df,
    'vits',
    key_features,
    readable_feature_names
)

"""–ê–Ω–∞–ª–∏–∑:
1. –ö–∞—á–µ—Å—Ç–≤–æ —Å–∏–Ω—Ç–µ–∑–∞: VITS –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á—É—Ç—å —Ö—É–∂–µ FastPitch ‚Äî –ª—É—á—à–∏–π –ø—Ä–∏–∑–Ω–∞–∫ –¥–∞–µ—Ç 36.1% –æ—à–∏–±–æ–∫ (–ø—Ä–æ—Ç–∏–≤ 38.7% —É FastPitch).

2. –ì–ª–∞–≤–Ω–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å: –í–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–∞—É–∑ (EER 36.1%)

VITS –¥–µ–ª–∞–µ—Ç –ø–∞—É–∑—ã –Ω–∞ 25.1% –±–æ–ª–µ–µ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–º–∏ (–Ω–µ –æ–¥–Ω–æ—Ä–æ–¥–Ω—ã–º–∏, –∫–∞–∫ FastPitch!)
- Real: 0.0589 ¬± 0.0286
- VITS: 0.0737 ¬± 0.0439 (–±–æ–ª—å—à–µ —Ä–∞–∑–±—Ä–æ—Å)

3. –ü–∞—Ç—Ç–µ—Ä–Ω —Ä–∞–∑–ª–∏—á–∏–π:

- –ü–∞—É–∑—ã: +25.1% (–ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ FastPitch!)
- –ò–Ω—Ç–æ–Ω–∞—Ü–∏—è: +20.8% (—Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ–≤—ã—à–µ–Ω–∏—è)
- –ì—Ä–æ–º–∫–æ—Å—Ç—å: +4.4% (–ø–æ—Ö–æ–∂–µ –Ω–∞ FastPitch)
- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: +2.7% (—Ö–æ—Ä–æ—à–æ)
4. –û—Ç–ª–∏—á–∏–µ –æ—Ç FastPitch:

FastPitch: –ø–∞—É–∑—ã —Å–ª–∏—à–∫–æ–º –æ–¥–Ω–æ—Ä–æ–¥–Ω—ã–µ (-13.7%)
VITS: –ø–∞—É–∑—ã —Å–ª–∏—à–∫–æ–º —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ (+25.1%)
VITS —Ö—É–∂–µ —Å –∏–Ω—Ç–æ–Ω–∞—Ü–∏–µ–π (+20.8% –ø—Ä–æ—Ç–∏–≤ FastPitch)

VITS –ª–µ–≥—á–µ –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è, —á–µ–º FastPitch. –ï–≥–æ —Å–ª–∞–±–æ—Å—Ç–∏: –∏–∑–±—ã—Ç–æ—á–Ω–∞—è –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–∞—É–∑ –∏ –Ω–µ–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –¥–∏–Ω–∞–º–∏–∫–∞ –∏–Ω—Ç–æ–Ω–∞—Ü–∏–∏.

## FastPitch –∏ VITS
"""

import matplotlib.pyplot as plt
import seaborn as sns

def compare_synthesis_systems(results_fp, results_vits, readable_names):
    """
    –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –¥–ª—è FastPitch –∏ VITS
    """

    comparison_data = []

    for feature in results_fp.keys():
        if feature in results_vits:
            comparison_data.append({
                '–ü—Ä–∏–∑–Ω–∞–∫': readable_names.get(feature, feature)[:45],
                'EER_FastPitch': results_fp[feature]['eer'],
                'EER_VITS': results_vits[feature]['eer'],
                'Diff_FP': results_fp[feature]['diff_pct'],
                'Diff_VITS': results_vits[feature]['diff_pct'],
                '–†–∞–∑–Ω–∏—Ü–∞_EER': abs(results_fp[feature]['eer'] - results_vits[feature]['eer']),
                '–õ—É—á—à–µ_–¥–ª—è': 'FastPitch' if results_fp[feature]['eer'] < results_vits[feature]['eer'] else 'VITS'
            })

    df_comp = pd.DataFrame(comparison_data)
    df_comp = df_comp.sort_values('–†–∞–∑–Ω–∏—Ü–∞_EER', ascending=False)

    print(f"\n –¢–∞–±–ª–∏—Ü–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ —Ä–∞–∑–ª–∏—á–∏—é EER):")
    print(df_comp[['–ü—Ä–∏–∑–Ω–∞–∫', 'EER_FastPitch', 'EER_VITS', '–†–∞–∑–Ω–∏—Ü–∞_EER', '–õ—É—á—à–µ_–¥–ª—è']].to_string(index=False))

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    fp_better = (df_comp['–õ—É—á—à–µ_–¥–ª—è'] == 'FastPitch').sum()
    vits_better = (df_comp['–õ—É—á—à–µ_–¥–ª—è'] == 'VITS').sum()

    print(f"   –ü—Ä–∏–∑–Ω–∞–∫–æ–≤, –≥–¥–µ FastPitch —Ç—Ä—É–¥–Ω–µ–µ –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: {fp_better}")
    print(f"   –ü—Ä–∏–∑–Ω–∞–∫–æ–≤, –≥–¥–µ VITS —Ç—Ä—É–¥–Ω–µ–µ –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: {vits_better}")
    print(f"   –°—Ä–µ–¥–Ω–∏–π EER FastPitch: {df_comp['EER_FastPitch'].mean():.3f}")
    print(f"   –°—Ä–µ–¥–Ω–∏–π EER VITS: {df_comp['EER_VITS'].mean():.3f}")

    # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
    fig, axes = plt.subplots(2, 2, figsize=(16, 12))

    # –ì—Ä–∞—Ñ–∏–∫ 1: Scatter plot - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ EER
    ax1 = axes[0, 0]
    ax1.scatter(df_comp['EER_FastPitch'], df_comp['EER_VITS'],
                s=150, alpha=0.6, c='steelblue', edgecolors='black', linewidths=2)
    ax1.plot([0.3, 0.6], [0.3, 0.6], 'r--', linewidth=2, label='–û–¥–∏–Ω–∞–∫–æ–≤–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å')
    ax1.set_xlabel('EER –¥–ª—è FastPitch', fontsize=13, fontweight='bold')
    ax1.set_ylabel('EER –¥–ª—è VITS', fontsize=13, fontweight='bold')
    ax1.set_title('–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤\n(–±–ª–∏–∂–µ –∫ –ª–∏–Ω–∏–∏ = –ø–æ—Ö–æ–∂–∞—è –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å)',
                  fontsize=14, fontweight='bold')
    ax1.legend(fontsize=11)
    ax1.grid(True, alpha=0.3)
    ax1.set_xlim(0.3, 0.6)
    ax1.set_ylim(0.3, 0.6)

    # –ê–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –¥–ª—è –∫—Ä–∞–π–Ω–∏—Ö —Ç–æ—á–µ–∫
    for _, row in df_comp.nlargest(3, '–†–∞–∑–Ω–∏—Ü–∞_EER').iterrows():
        ax1.annotate(row['–ü—Ä–∏–∑–Ω–∞–∫'][:25],
                    xy=(row['EER_FastPitch'], row['EER_VITS']),
                    xytext=(10, 10), textcoords='offset points',
                    fontsize=9, alpha=0.8,
                    bbox=dict(boxstyle='round,pad=0.4', facecolor='yellow', alpha=0.4),
                    arrowprops=dict(arrowstyle='->', color='gray'))

    # –ì—Ä–∞—Ñ–∏–∫ 2: Bar plot - –¢–û–ü-5 –¥–ª—è –∫–∞–∂–¥–æ–π —Å–∏—Å—Ç–µ–º—ã
    ax2 = axes[0, 1]
    top5 = df_comp.nsmallest(5, 'EER_FastPitch')

    x = np.arange(len(top5))
    width = 0.35

    bars1 = ax2.barh(x - width/2, top5['EER_FastPitch'], width,
                     label='FastPitch', color='coral', alpha=0.8, edgecolor='black')
    bars2 = ax2.barh(x + width/2, top5['EER_VITS'], width,
                     label='VITS', color='skyblue', alpha=0.8, edgecolor='black')

    ax2.set_yticks(x)
    ax2.set_yticklabels([f[:35] for f in top5['–ü—Ä–∏–∑–Ω–∞–∫']], fontsize=10)
    ax2.set_xlabel('EER (–º–µ–Ω—å—à–µ = –ª—É—á—à–µ –¥–µ—Ç–µ–∫—Ü–∏—è)', fontsize=12, fontweight='bold')
    ax2.set_title('–¢–û–ü-5 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏', fontsize=14, fontweight='bold')
    ax2.legend(fontsize=11)
    ax2.invert_yaxis()
    ax2.grid(True, alpha=0.3, axis='x')

    # –ì—Ä–∞—Ñ–∏–∫ 3: –†–∞–∑–ª–∏—á–∏—è –≤ —Å—Ä–µ–¥–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö
    ax3 = axes[1, 0]
    features_plot = df_comp.nlargest(8, '–†–∞–∑–Ω–∏—Ü–∞_EER')['–ü—Ä–∏–∑–Ω–∞–∫'].tolist()
    diff_fp = [df_comp[df_comp['–ü—Ä–∏–∑–Ω–∞–∫'] == f]['Diff_FP'].values[0] for f in features_plot]
    diff_vits = [df_comp[df_comp['–ü—Ä–∏–∑–Ω–∞–∫'] == f]['Diff_VITS'].values[0] for f in features_plot]

    x = np.arange(len(features_plot))
    width = 0.35

    ax3.barh(x - width/2, diff_fp, width, label='FastPitch', color='coral', alpha=0.8)
    ax3.barh(x + width/2, diff_vits, width, label='VITS', color='skyblue', alpha=0.8)

    ax3.set_yticks(x)
    ax3.set_yticklabels([f[:30] for f in features_plot], fontsize=9)
    ax3.set_xlabel('–†–∞–∑–Ω–∏—Ü–∞ –æ—Ç Real (%)', fontsize=12, fontweight='bold')
    ax3.set_title('–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –≤–µ–ª–∏—á–∏–Ω–∞ –æ—Ç–ª–∏—á–∏–π –æ—Ç –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–æ–π —Ä–µ—á–∏',
                  fontsize=14, fontweight='bold')
    ax3.axvline(x=0, color='black', linestyle='-', linewidth=1)
    ax3.legend(fontsize=11)
    ax3.invert_yaxis()
    ax3.grid(True, alpha=0.3, axis='x')

    # –ì—Ä–∞—Ñ–∏–∫ 4: –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
    ax4 = axes[1, 1]
    ax4.axis('tight')
    ax4.axis('off')

    summary_data = [
        ['–ú–µ—Ç—Ä–∏–∫–∞', 'FastPitch', 'VITS', '–ü–æ–±–µ–¥–∏—Ç–µ–ª—å'],
        ['‚îÄ'*20, '‚îÄ'*15, '‚îÄ'*15, '‚îÄ'*15],
        ['–°—Ä–µ–¥–Ω–∏–π EER', f"{df_comp['EER_FastPitch'].mean():.3f}",
         f"{df_comp['EER_VITS'].mean():.3f}",
         'FastPitch' if df_comp['EER_FastPitch'].mean() > df_comp['EER_VITS'].mean() else 'VITS'],
        ['–õ—É—á—à–∏–π EER', f"{df_comp['EER_FastPitch'].min():.3f}",
         f"{df_comp['EER_VITS'].min():.3f}",
         'FastPitch' if df_comp['EER_FastPitch'].min() > df_comp['EER_VITS'].min() else 'VITS'],
        ['–•—É–¥—à–∏–π EER', f"{df_comp['EER_FastPitch'].max():.3f}",
         f"{df_comp['EER_VITS'].max():.3f}",
         'FastPitch' if df_comp['EER_FastPitch'].max() > df_comp['EER_VITS'].max() else 'VITS'],
        ['–ü—Ä–∏–∑–Ω–∞–∫–æ–≤ —Ç—Ä—É–¥–Ω–µ–µ\n–¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å', str(fp_better), str(vits_better),
         'FastPitch' if fp_better > vits_better else 'VITS'],
    ]

    table = ax4.table(cellText=summary_data, cellLoc='center', loc='center',
                     colWidths=[0.3, 0.2, 0.2, 0.3])
    table.auto_set_font_size(False)
    table.set_fontsize(11)
    table.scale(1, 2.5)

    # –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã
    for i in range(len(summary_data)):
        for j in range(4):
            cell = table[(i, j)]
            if i == 0:
                cell.set_facecolor('#4472C4')
                cell.set_text_props(weight='bold', color='white')
            elif i == 1:
                cell.set_facecolor('#E7E6E6')
            else:
                cell.set_facecolor('#F2F2F2' if i % 2 == 0 else 'white')

    ax4.set_title('–°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n(–±–æ–ª—å—à–∏–π EER = —Ç—Ä—É–¥–Ω–µ–µ –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å)',
                  fontsize=14, fontweight='bold', pad=20)

    plt.suptitle('–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ FastPitch –∏ VITS',
                 fontsize=16, fontweight='bold', y=0.995)
    plt.tight_layout()
    plt.savefig('/content/synthesis_comparison.png', dpi=300, bbox_inches='tight')
    plt.show()

    return df_comp


comparison_df = compare_synthesis_systems(
    results_fastpitch,
    results_vits,
    readable_feature_names
)

"""–ê–Ω–∞–ª–∏–∑:
1. FastPitch –Ω–µ–º–Ω–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–µ–µ:

–°—Ä–µ–¥–Ω–∏–π EER: 0.495 (FastPitch) vs 0.502 (VITS)
FastPitch —Ç—Ä—É–¥–Ω–µ–µ –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ 6 –ø—Ä–∏–∑–Ω–∞–∫–∞–º, VITS ‚Äî –ø–æ 7

2. –ö–ª—é—á–µ–≤—ã–µ —Ä–∞–∑–ª–∏—á–∏—è —Å–∏—Å—Ç–µ–º:

FastPitch:

- –õ—É—á—à–µ –∏–º–∏—Ç–∏—Ä—É–µ—Ç: —Å–ø–µ–∫—Ç—Ä, –≥—Ä–æ–º–∫–æ—Å—Ç—å, —Ä–∏—Ç–º
- –°–ª–∞–±–æ—Å—Ç—å: –æ–¥–Ω–æ—Ä–æ–¥–Ω—ã–µ –ø–∞—É–∑—ã (-13.7%)

VITS:

- –õ—É—á—à–µ –∏–º–∏—Ç–∏—Ä—É–µ—Ç: –≤—ã—Å–æ—Ç—É –≥–æ–ª–æ—Å–∞, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–∞—É–∑
- –°–ª–∞–±–æ—Å—Ç–∏: –∏–∑–±—ã—Ç–æ—á–Ω–∞—è –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–∞—É–∑ (+25.1%), –Ω–µ–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∏–Ω—Ç–æ–Ω–∞—Ü–∏—è (+20.8%)
3. –ù–∞–∏–±–æ–ª—å—à–∏–µ —Ä–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É —Å–∏—Å—Ç–µ–º–∞–º–∏:

–°–ø–µ–∫—Ç—Ä: FastPitch –Ω–∞ 13.4% —Ç—Ä—É–¥–Ω–µ–µ (EER 0.45 vs 0.59)
–ì—Ä–æ–º–∫–æ—Å—Ç—å: FastPitch –Ω–∞ 9.9% —Ç—Ä—É–¥–Ω–µ–µ (EER 0.51 vs 0.61)
–ò–Ω—Ç–æ–Ω–∞—Ü–∏—è: VITS –Ω–∞ 9% —Ç—Ä—É–¥–Ω–µ–µ (EER 0.44 vs 0.53)


–û–±–µ —Å–∏—Å—Ç–µ–º—ã –æ—á–µ–Ω—å –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ (—Å—Ä–µ–¥–Ω–∏–π EER ~50% ‚âà —Å–ª—É—á–∞–π–Ω–æ–µ —É–≥–∞–¥—ã–≤–∞–Ω–∏–µ). FastPitch —á—É—Ç—å –ª—É—á—à–µ –≤ —Ü–µ–ª–æ–º, –Ω–æ –∏–º–µ–µ—Ç –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã: FastPitch –¥–µ–ª–∞–µ—Ç –ø–∞—É–∑—ã —Å–ª–∏—à–∫–æ–º —Å—Ç–∞–±–∏–ª—å–Ω—ã–º–∏, VITS ‚Äî —Å–ª–∏—à–∫–æ–º —Ö–∞–æ—Ç–∏—á–Ω—ã–º–∏.

## –ö—Ä–æ—Å—Å-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
"""

from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import accuracy_score, roc_auc_score, classification_report
import numpy as np

def cross_test_models(features_df, key_features, readable_names):
    """
    –ö—Ä–æ—Å—Å-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
    - –û–±—É—á–µ–Ω–∏–µ –Ω–∞ FastPitch ‚Üí —Ç–µ—Å—Ç –Ω–∞ VITS
    - –û–±—É—á–µ–Ω–∏–µ –Ω–∞ VITS ‚Üí —Ç–µ—Å—Ç –Ω–∞ FastPitch
    """
    print("\n" + "="*80)
    print("–ö–†–û–°–°-–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ú–û–î–ï–õ–ï–ô")
    print("="*80)

    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    df_real = features_df[features_df['synthesis_type'] == 'real']
    df_fastpitch = features_df[features_df['synthesis_type'] == 'fastpitch']
    df_vits = features_df[features_df['synthesis_type'] == 'vits']

    print(f"\nüìä –†–∞–∑–º–µ—Ä—ã –≤—ã–±–æ—Ä–æ–∫:")
    print(f"   Real: {len(df_real)}")
    print(f"   FastPitch: {len(df_fastpitch)}")
    print(f"   VITS: {len(df_vits)}")

    # –í—ã–±–æ—Ä –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
    X_cols = key_features

    # ============================================================
    # –¢–µ—Å—Ç 1: –û–±—É—á–µ–Ω–∏–µ –Ω–∞ FastPitch ‚Üí –¢–µ—Å—Ç –Ω–∞ VITS
    # ============================================================
    print("\n" + "‚îÄ"*80)
    print("–¢–ï–°–¢ 1: –ú–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∞ –Ω–∞ FastPitch ‚Üí —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–∞ VITS")
    print("‚îÄ"*80)

    # –û–±—É—á–∞—é—â–∞—è –≤—ã–±–æ—Ä–∫–∞: Real + FastPitch
    train_fp = pd.concat([df_real, df_fastpitch])
    X_train_fp = train_fp[X_cols]
    y_train_fp = (train_fp['synthesis_type'] == 'fastpitch').astype(int)

    # –¢–µ—Å—Ç–æ–≤–∞—è –≤—ã–±–æ—Ä–∫–∞: Real + VITS
    test_vits = pd.concat([df_real, df_vits])
    X_test_vits = test_vits[X_cols]
    y_test_vits = (test_vits['synthesis_type'] == 'vits').astype(int)

    # –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
    model_fp = RandomForestClassifier(n_estimators=100, max_depth=10, random_state=42)
    model_fp.fit(X_train_fp, y_train_fp)

    # –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ VITS
    y_pred_vits = model_fp.predict(X_test_vits)
    y_pred_proba_vits = model_fp.predict_proba(X_test_vits)[:, 1]

    acc_fp_on_vits = accuracy_score(y_test_vits, y_pred_vits)
    roc_fp_on_vits = roc_auc_score(y_test_vits, y_pred_proba_vits)

    print(f"\nüìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:")
    print(f"   Accuracy: {acc_fp_on_vits:.3f} ({acc_fp_on_vits*100:.1f}%)")
    print(f"   ROC-AUC:  {roc_fp_on_vits:.3f}")
    print(f"\nüìã –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç:")
    print(classification_report(y_test_vits, y_pred_vits,
                                target_names=['Real', 'VITS'], digits=3))

    # ============================================================
    # –¢–µ—Å—Ç 2: –û–±—É—á–µ–Ω–∏–µ –Ω–∞ VITS ‚Üí –¢–µ—Å—Ç –Ω–∞ FastPitch
    # ============================================================
    print("\n" + "‚îÄ"*80)
    print("–¢–ï–°–¢ 2: –ú–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∞ –Ω–∞ VITS ‚Üí —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–∞ FastPitch")
    print("‚îÄ"*80)

    # –û–±—É—á–∞—é—â–∞—è –≤—ã–±–æ—Ä–∫–∞: Real + VITS
    train_vits = pd.concat([df_real, df_vits])
    X_train_vits = train_vits[X_cols]
    y_train_vits = (train_vits['synthesis_type'] == 'vits').astype(int)

    # –¢–µ—Å—Ç–æ–≤–∞—è –≤—ã–±–æ—Ä–∫–∞: Real + FastPitch
    test_fp = pd.concat([df_real, df_fastpitch])
    X_test_fp = test_fp[X_cols]
    y_test_fp = (test_fp['synthesis_type'] == 'fastpitch').astype(int)

    # –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
    model_vits = RandomForestClassifier(n_estimators=100, max_depth=10, random_state=42)
    model_vits.fit(X_train_vits, y_train_vits)

    # –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ FastPitch
    y_pred_fp = model_vits.predict(X_test_fp)
    y_pred_proba_fp = model_vits.predict_proba(X_test_fp)[:, 1]

    acc_vits_on_fp = accuracy_score(y_test_fp, y_pred_fp)
    roc_vits_on_fp = roc_auc_score(y_test_fp, y_pred_proba_fp)

    print(f"\nüìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:")
    print(f"   Accuracy: {acc_vits_on_fp:.3f} ({acc_vits_on_fp*100:.1f}%)")
    print(f"   ROC-AUC:  {roc_vits_on_fp:.3f}")
    print(f"\nüìã –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç:")
    print(classification_report(y_test_fp, y_pred_fp,
                                target_names=['Real', 'FastPitch'], digits=3))

    # ============================================================
    # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å "—Ä–æ–¥–Ω—ã–º–∏" –º–æ–¥–µ–ª—è–º–∏
    # ============================================================
    print("\n" + "="*80)
    print("–°–†–ê–í–ù–ï–ù–ò–ï –° –û–ë–£–ß–ï–ù–ò–ï–ú –ù–ê –¢–û–ô –ñ–ï –°–ò–°–¢–ï–ú–ï")
    print("="*80)

    # –ú–æ–¥–µ–ª—å –Ω–∞ FastPitch (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏)
    model_fp_native = RandomForestClassifier(n_estimators=100, max_depth=10, random_state=42)
    model_fp_native.fit(X_train_fp, y_train_fp)
    y_pred_fp_native = model_fp_native.predict(X_test_fp)
    y_pred_proba_fp_native = model_fp_native.predict_proba(X_test_fp)[:, 1]
    acc_fp_native = accuracy_score(y_test_fp, y_pred_fp_native)
    roc_fp_native = roc_auc_score(y_test_fp, y_pred_proba_fp_native)

    # –ú–æ–¥–µ–ª—å –Ω–∞ VITS (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏)
    model_vits_native = RandomForestClassifier(n_estimators=100, max_depth=10, random_state=42)
    model_vits_native.fit(X_train_vits, y_train_vits)
    y_pred_vits_native = model_vits_native.predict(X_test_vits)
    y_pred_proba_vits_native = model_vits_native.predict_proba(X_test_vits)[:, 1]
    acc_vits_native = accuracy_score(y_test_vits, y_pred_vits_native)
    roc_vits_native = roc_auc_score(y_test_vits, y_pred_proba_vits_native)

    # –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞
    results_summary = pd.DataFrame({
        '–°—Ü–µ–Ω–∞—Ä–∏–π': [
            'FastPitch ‚Üí FastPitch (—Ä–æ–¥–Ω–∞—è)',
            'VITS ‚Üí FastPitch (–∫—Ä–æ—Å—Å)',
            'VITS ‚Üí VITS (—Ä–æ–¥–Ω–∞—è)',
            'FastPitch ‚Üí VITS (–∫—Ä–æ—Å—Å)'
        ],
        'Accuracy': [
            acc_fp_native,
            acc_vits_on_fp,
            acc_vits_native,
            acc_fp_on_vits
        ],
        'ROC-AUC': [
            roc_fp_native,
            roc_vits_on_fp,
            roc_vits_native,
            roc_fp_on_vits
        ]
    })

    print("\nüìä –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞:")
    print(results_summary.to_string(index=False))

    # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
    fig, axes = plt.subplots(1, 2, figsize=(16, 6))

    # –ì—Ä–∞—Ñ–∏–∫ 1: Accuracy
    ax1 = axes[0]
    scenarios = ['FP‚ÜíFP\n(—Ä–æ–¥–Ω–∞—è)', 'VITS‚ÜíFP\n(–∫—Ä–æ—Å—Å)', 'VITS‚ÜíVITS\n(—Ä–æ–¥–Ω–∞—è)', 'FP‚ÜíVITS\n(–∫—Ä–æ—Å—Å)']
    accuracies = results_summary['Accuracy'].values
    colors = ['green', 'orange', 'green', 'orange']

    bars = ax1.bar(scenarios, accuracies, color=colors, alpha=0.7, edgecolor='black', linewidth=2)
    ax1.set_ylabel('Accuracy', fontsize=13, fontweight='bold')
    ax1.set_title('–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ –º–æ–¥–µ–ª–µ–π', fontsize=14, fontweight='bold')
    ax1.set_ylim(0, 1)
    ax1.axhline(y=0.5, color='red', linestyle='--', label='–°–ª—É—á–∞–π–Ω–æ–µ —É–≥–∞–¥—ã–≤–∞–Ω–∏–µ')
    ax1.legend()
    ax1.grid(True, alpha=0.3, axis='y')

    for bar, acc in zip(bars, accuracies):
        height = bar.get_height()
        ax1.text(bar.get_x() + bar.get_width()/2., height + 0.02,
                f'{acc:.3f}\n({acc*100:.1f}%)',
                ha='center', va='bottom', fontsize=11, fontweight='bold')

    # –ì—Ä–∞—Ñ–∏–∫ 2: ROC-AUC
    ax2 = axes[1]
    roc_aucs = results_summary['ROC-AUC'].values

    bars2 = ax2.bar(scenarios, roc_aucs, color=colors, alpha=0.7, edgecolor='black', linewidth=2)
    ax2.set_ylabel('ROC-AUC', fontsize=13, fontweight='bold')
    ax2.set_title('–°—Ä–∞–≤–Ω–µ–Ω–∏–µ ROC-AUC –º–æ–¥–µ–ª–µ–π', fontsize=14, fontweight='bold')
    ax2.set_ylim(0, 1)
    ax2.axhline(y=0.5, color='red', linestyle='--', label='–°–ª—É—á–∞–π–Ω–æ–µ —É–≥–∞–¥—ã–≤–∞–Ω–∏–µ')
    ax2.legend()
    ax2.grid(True, alpha=0.3, axis='y')

    for bar, roc in zip(bars2, roc_aucs):
        height = bar.get_height()
        ax2.text(bar.get_x() + bar.get_width()/2., height + 0.02,
                f'{roc:.3f}',
                ha='center', va='bottom', fontsize=11, fontweight='bold')

    plt.suptitle('–ö—Ä–æ—Å—Å-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –æ–±–æ–±—â–∞—é—â–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–µ–π',
                 fontsize=16, fontweight='bold')
    plt.tight_layout()
    plt.savefig('/content/cross_testing_results.png', dpi=300, bbox_inches='tight')
    plt.show()

    return results_summary


# –ó–ê–ü–£–°–ö –ö–†–û–°–°-–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø
results_summary = cross_test_models(features_df, key_features, readable_feature_names)

"""–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

1. –ú–æ–¥–µ–ª–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—Ç —Ö–æ—Ä–æ—à—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫ –æ–±–æ–±—â–µ–Ω–∏—é –º–µ–∂–¥—É —Å–∏—Å—Ç–µ–º–∞–º–∏

–ü—Ä–∏ –∫—Ä–æ—Å—Å-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–æ–ª—É—á–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:

- –ú–æ–¥–µ–ª—å, –æ–±—É—á–µ–Ω–Ω–∞—è –Ω–∞ VITS –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –Ω–∞ FastPitch: —Ç–æ—á–Ω–æ—Å—Ç—å 77.5%, ROC-AUC 0.932
- –ú–æ–¥–µ–ª—å, –æ–±—É—á–µ–Ω–Ω–∞—è –Ω–∞ FastPitch –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –Ω–∞ VITS: —Ç–æ—á–Ω–æ—Å—Ç—å 79.9%, ROC-AUC 0.942

–î–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –º–æ–¥–µ–ª–∏, –æ–±—É—á–µ–Ω–Ω—ã–µ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞ –¥–∞–Ω–Ω—ã—Ö –æ–¥–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã:

- FastPitch (–æ–±—É—á–µ–Ω–∏–µ –∏ —Ç–µ—Å—Ç –Ω–∞ FastPitch): —Ç–æ—á–Ω–æ—Å—Ç—å 98.7%, ROC-AUC 0.999
- VITS (–æ–±—É—á–µ–Ω–∏–µ –∏ —Ç–µ—Å—Ç –Ω–∞ VITS): —Ç–æ—á–Ω–æ—Å—Ç—å 99.4%, ROC-AUC 0.999
- –ü–æ—è—Å–Ω–µ–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–∞ "—Ä–æ–¥–Ω—ã–µ –º–æ–¥–µ–ª–∏": –º–æ–¥–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—É—á–∞–ª–∏—Å—å –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–∏—Å—å –Ω–∞ –¥–∞–Ω–Ω—ã—Ö –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ —Å–∏—Å—Ç–µ–º—ã —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–±—É—á–µ–Ω–∏–µ –Ω–∞ FastPitch, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ FastPitch).

2. –°–Ω–∏–∂–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–∏ –∫—Ä–æ—Å—Å-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ 20%
- –ü—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–π –∂–µ —Å–∏—Å—Ç–µ–º—ã: 98-99% —Ç–æ—á–Ω–æ—Å—Ç—å
- –ü—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–∞ –¥–∞–Ω–Ω—ã—Ö –¥—Ä—É–≥–æ–π —Å–∏—Å—Ç–µ–º—ã: 77-80% —Ç–æ—á–Ω–æ—Å—Ç—å
- –ü–æ—Ç–µ—Ä—è —Ç–æ—á–Ω–æ—Å—Ç–∏: 18-22 –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã—Ö –ø—É–Ω–∫—Ç–∞
3. –ù–∞–±–ª—é–¥–∞–µ—Ç—Å—è –∞—Å–∏–º–º–µ—Ç—Ä–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

–ú–æ–¥–µ–ª—å FastPitch ‚Üí VITS –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–æ–ª–µ–µ –≤—ã—Å–æ–∫—É—é —Ç–æ—á–Ω–æ—Å—Ç—å (79.9%)
–ú–æ–¥–µ–ª—å VITS ‚Üí FastPitch –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–æ–ª–µ–µ –Ω–∏–∑–∫—É—é —Ç–æ—á–Ω–æ—Å—Ç—å (77.5%)
–†–∞–∑–Ω–∏—Ü–∞ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 2.4 –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã—Ö –ø—É–Ω–∫—Ç–∞
4. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–≤–æ–¥—ã
–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã:

- –ú–æ–¥–µ–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—Å—è –º–µ–∂–¥—É —Å–∏—Å—Ç–µ–º–∞–º–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ª—É—á—à–µ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ (50% —Ç–æ—á–Ω–æ—Å—Ç—å)
- ROC-AUC 0.93-0.94 —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ö–æ—Ä–æ—à—É—é —Ä–∞–∑–ª–∏—á–∏—Ç–µ–ª—å–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å

–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:

–°—É—â–µ—Å—Ç–≤—É—é—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –∫–∞–∂–¥–æ–π —Å–∏—Å—Ç–µ–º—ã:
FastPitch —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑—É–µ—Ç—Å—è –º–µ—Ö–∞–Ω–∏—Å—Ç–∏—á–Ω—ã–º–∏ –ø–∞—É–∑–∞–º–∏
VITS –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –∏–∑–±—ã—Ç–æ—á–Ω—É—é –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–∞—É–∑ –∏ –Ω–µ–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—É—é –∏–Ω—Ç–æ–Ω–∞—Ü–∏—é
–û–±—â–∏–π –≤—ã–≤–æ–¥:
–ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Ä–∞–∑–Ω–æ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å–∏–Ω—Ç–µ–∑–∞, –º–æ–¥–µ–ª–∏ —É—Å–ø–µ—à–Ω–æ –≤—ã—è–≤–ª—è—é—Ç –æ–±—â–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–æ–π —Ä–µ—á–∏ (–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≥—Ä–æ–º–∫–æ—Å—Ç–∏, —Å–ø–µ–∫—Ç—Ä–∞, —Ä–∏—Ç–º–∞), —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø—Ä–∏–µ–º–ª–µ–º—É—é —Ç–æ—á–Ω–æ—Å—Ç—å –∫—Ä–æ—Å—Å-—Å–∏—Å—Ç–µ–º–Ω–æ–π –¥–µ—Ç–µ–∫—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ 78%.

–í—ã–≤–æ–¥

–ö—Ä–æ—Å—Å-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑–∞–ª–æ, —á—Ç–æ –º–æ–¥–µ–ª–∏ Random Forest, –æ–±—É—á–µ–Ω–Ω—ã–µ –Ω–∞ –¥–∞–Ω–Ω—ã—Ö –æ–¥–Ω–æ–π TTS-—Å–∏—Å—Ç–µ–º—ã (Real + FastPitch –∏–ª–∏ Real + VITS), –¥–æ—Å—Ç–∏–≥–∞—é—Ç –ø–æ—á—Ç–∏ –∏–¥–µ–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ 98-99% –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–∞ —ç—Ç–æ–π –∂–µ —Å–∏—Å—Ç–µ–º–µ, –Ω–æ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ –Ω–∞ –¥—Ä—É–≥—É—é —Å–∏—Å—Ç–µ–º—É —Ç–æ—á–Ω–æ—Å—Ç—å –ø–∞–¥–∞–µ—Ç –¥–æ 77-80% (—á—Ç–æ –±–ª–∏–∑–∫–æ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è 72.7%), –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—è, —á—Ç–æ –∫–∞–∂–¥–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏–º–µ–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –∞–∫—É—Å—Ç–∏—á–µ—Å–∫–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã (FastPitch ‚Äî –º–µ—Ö–∞–Ω–∏—Å—Ç–∏—á–Ω—ã–µ –ø–∞—É–∑—ã, VITS ‚Äî —Ö–∞–æ—Ç–∏—á–Ω—ã–µ –ø–∞—É–∑—ã –∏ –Ω–µ–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∏–Ω—Ç–æ–Ω–∞—Ü–∏—è), –æ–¥–Ω–∞–∫–æ –º–æ–¥–µ–ª–∏ —É—Å–ø–µ—à–Ω–æ —É–ª–∞–≤–ª–∏–≤–∞—é—Ç –æ–±—â–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–æ–π —Ä–µ—á–∏ (–≥—Ä–æ–º–∫–æ—Å—Ç—å, —Å–ø–µ–∫—Ç—Ä, —Ä–∏—Ç–º), –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –ø—Ä–∏–µ–º–ª–µ–º—É—é —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é –¥–µ—Ç–µ–∫—Ü–∏—é –Ω–∞ —É—Ä–æ–≤–Ω–µ 72-80% –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–∏–ø–∞ TTS-—Å–∏—Å—Ç–µ–º—ã.
"""